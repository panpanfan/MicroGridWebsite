<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-05XLDKW0MN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-05XLDKW0MN');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIY System Registration - Step 1 - MicroGrid</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        :root {
            --brand-green: #10B981;
            --brand-green-dark: #065f46;
            --brand-green-medium: #059669;
            --brand-green-darker: #047857;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            padding: 1rem 0;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(16, 185, 129, 0.15);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #10B981;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cta-button {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .cta-button:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .cta-button-outline {
            background: transparent;
            color: var(--brand-green);
            padding: 0.5rem 1rem;
            border: 2px solid var(--brand-green);
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .cta-button-outline:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #6b7280;
        }

        /* Registration form section */
        .registration-form-section {
            padding: 140px 0 80px;
            background: #f8fafc;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 25%;
            right: 25%;
            height: 3px;
            background: #e5e7eb;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .progress-step.completed .progress-step-circle {
            background: #10B981;
            color: white;
        }

        .progress-step.active .progress-step-circle {
            background: #10B981;
            color: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .progress-step-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-step.active .progress-step-label {
            color: #059669;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-top: 0.25rem;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: 400;
            line-height: 1.5;
        }

        .submit-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        .file-upload-container {
            margin-top: 0.5rem;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #059669;
            background: #f0fdf4;
        }

        .file-upload-area.drag-over {
            border-color: #059669;
            background: #ecfdf5;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .upload-subtext {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: #059669;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .file-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .file-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            color: #333;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                padding: 1rem;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                gap: 0;
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links li {
                padding: 0.75rem 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .nav-links li:last-child {
                border-bottom: none;
            }

            .form-container {
                padding: 2rem 1.5rem;
                margin: 0 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .progress-bar::before {
                left: 20%;
                right: 20%;
            }
        }

        @media (max-width: 640px) {
            .cta-button.hide-mobile {
                display: none;
            }
        }

        /* Sticky CTA Bar */
        .sticky-cta-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(16, 185, 129, 0.15);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            padding: 1rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .cta-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .cta-bar-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            flex-shrink: 0;
        }

        .cta-bar-buttons {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .cta-bar-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cta-bar-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        body {
            padding-bottom: 100px;
        }

        @media (max-width: 768px) {
            .cta-bar-content {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .cta-bar-text {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .cta-bar-buttons {
                width: 100%;
                justify-content: center;
            }

            .cta-bar-primary {
                flex: 1;
                min-width: 140px;
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .sticky-cta-bar {
                padding: 1rem 0.75rem;
            }

            body {
                padding-bottom: 140px;
            }
        }

        @media (max-width: 480px) {
            .cta-bar-primary {
                width: 100%;
                padding: 1rem;
            }

            body {
                padding-bottom: 160px;
            }
        }

        /* Footer */
        footer {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: white;
            padding: 2.5rem 0;
            border-top: 1px solid rgba(16, 185, 129, 0.1);
        }

        .footer-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: var(--brand-green);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .footer-logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .footer-logo-title {
            font-weight: 800;
            font-size: 1rem;
        }

        .footer-logo-subtitle {
            font-size: 0.875rem;
            color: #9CA3AF;
        }

        .footer-tagline {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            letter-spacing: -0.015em;
        }

        .footer-nav {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .footer-nav a {
            color: #9CA3AF;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-nav a:hover {
            color: white;
        }

        .footer-copyright {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            text-align: center;
        }

        .footer-copyright p {
            font-size: 0.875rem;
            color: #9CA3AF;
            margin: 0;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="container">
            <a href="index.html" class="logo">
                <img src="assets/images/microgrid_logo.png" alt="MicroGrid" height="50">
            </a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#join-movement">How It Works</a></li>
                <li><a href="index.html#nem">California (NEM 3.0)</a></li>
                <li><a href="index.html#impact">Results</a></li>
                <li><a href="index.html#compat">Compatibility</a></li>
                <li><a href="index.html#faq">FAQ</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="header-buttons">
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">â˜°</button>
                <a href="diy-registration.html" class="cta-button hide-mobile">Start Free</a>
                <a href="https://apps.apple.com/us/app/dgrid/id6747276150" class="cta-button-outline">Download App</a>
            </div>
        </nav>
    </header>

    <!-- Registration Form Section -->
    <section class="registration-form-section">
        <div class="container">
            <div class="form-container">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-step active">
                        <div class="progress-step-circle">1</div>
                        <div class="progress-step-label">Contact Info</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">2</div>
                        <div class="progress-step-label">System Setup</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2>Start Your Smart Battery Journey</h2>
                    <p>Just 2 quick steps to unlock AI optimization and start earning</p>
                </div>

                <form id="step1Form" action="#" method="POST">
                    
                    <h2 style="font-size: 1.5rem; color: #059669; margin-bottom: 0.5rem;">Step 1 â€” Tell Us About Yourself</h2>
                    <p style="color: #6b7280; margin-bottom: 2rem;">We'll save your info so you don't lose progress. This helps us prepare your personalized estimate.</p>
                    
                    <div class="form-group full-width">
                        <label for="fullName">Full Name or Preferred Name *</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Enter your full name or preferred name" required>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" name="email" placeholder="you@example.com" required>
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">We'll send your earning estimates and setup instructions.</small>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="phone" placeholder="(800) 555-0100 or 8005550100">
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">US phone numbers only. Enter 10 digits.</small>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="address">Address</label>
                        <input type="text" id="address" name="address" placeholder="Street address (optional)">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" placeholder="City" required>
                            <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">Certain utility rules differ by location.</small>
                        </div>
                        <div class="form-group">
                            <label for="state">State *</label>
                            <select id="state" name="state" required>
                                <option value="">Select State</option>
                                <option value="California" selected>California</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="utilityCompany">Utility Company</label>
                        <select id="utilityCompany" name="utilityCompany">
                            <option value="">Select Utility Company</option>
                            <option value="PG&E">Pacific Gas & Electric (PG&E)</option>
                            <option value="SCE">Southern California Edison (SCE)</option>
                            <option value="SDG&E">San Diego Gas & Electric (SDG&E)</option>
                            <option value="SMUD">Sacramento Municipal Utility District (SMUD)</option>
                            <option value="LADWP">Los Angeles Department of Water and Power (LADWP)</option>
                            <option value="Other">Other Utility</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="electricityBills">Upload Recent Electricity Bills (Optional)</label>
                        <div class="file-upload-container">
                            <div class="file-upload-area" id="fileUploadArea">
                                <div class="upload-icon">ðŸ“„</div>
                                <p class="upload-text">Click to upload or drag and drop</p>
                                <p class="upload-subtext">Upload up to 12 files (PDF or images) â€” more recent bills are better</p>
                                <input type="file" id="electricityBills" name="electricityBills" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;">
                            </div>
                            <div id="fileList" class="file-list"></div>
                        </div>
                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                            <strong style="color: #059669;">Optional but helpful:</strong> Helps our AI estimate your savings faster. You can skip this step and add bills later.
                        </small>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="terms" name="terms" required>
                        <label for="terms">I agree to the <a href="terms.html" style="color: #059669;">Terms of Service</a> and <a href="privacy.html" style="color: #059669;">Privacy Policy</a> *</label>
                    </div>

                    <p style="text-align: center; margin: 1.5rem 0 0.75rem 0; padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border-radius: 12px; border: 2px solid #10B981;">
                        <span style="display: block; color: #059669; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">âœ¨ YOUR PROGRESS IS SAVED</span>
                        <span style="display: block; color: #047857; font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">We'll save your info when you click continue</span>
                        <span style="display: block; color: #6b7280; font-size: 0.85rem;">You won't lose any data if you need to come back later</span>
                    </p>

                    <button type="submit" class="submit-btn" id="submitBtn">Save & Continue to Step 2 â†’</button>
                    
                    <p style="text-align: center; margin-top: 1rem; color: #6b7280; font-size: 0.95rem;">ðŸ’¡ Takes less than 2 minutes to complete both steps.</p>

                    <small style="display: block; text-align: center; margin-top: 1.5rem; color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                        By continuing you agree to our <a href="privacy.html" style="color: #059669;">Privacy Policy</a>.  
                        We only read system data to generate savings; we never sell personal data.
                    </small>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="footer-logo-icon"></span>
                    <div class="footer-logo-text">
                        <div class="footer-logo-title">MicroVPPâ„¢</div>
                        <div class="footer-logo-subtitle">by MicroGrid</div>
                    </div>
                </div>
                <div class="footer-tagline">Smarter homes. Stronger grids.</div>
                <nav class="footer-nav">
                    <a href="index.html">Home</a>
                    <a href="about.html">About</a>
                    <a href="privacy.html">Privacy</a>
                    <a href="terms.html">Terms</a>
                    <a href="mailto:info@microvpp.com">Contact</a>
                </nav>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2025 MicroGrid LLC. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Sticky CTA Bar -->
    <div class="sticky-cta-bar">
        <div class="cta-bar-content">
            <div class="cta-bar-text">Ready to activate your smart battery?</div>
            <div class="cta-bar-buttons">
                <a href="https://apps.apple.com/us/app/dgrid/id6747276150" class="cta-bar-primary">Download App</a>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FORM ANALYTICS TRACKING
        // ============================================
        
        const FormTracker = {
            formStarted: false,
            fieldsInteracted: new Set(),
            abandonmentTimer: null,
            
            trackFormStart() {
                if (!this.formStarted) {
                    this.formStarted = true;
                    gtag('event', 'form_start', {
                        form_name: 'diy_registration_step1',
                        form_type: 'registration'
                    });
                    console.log('ðŸ“Š Analytics: Form Step 1 started');
                }
            },
            
            trackFieldInteraction(fieldName, fieldType) {
                if (!this.fieldsInteracted.has(fieldName)) {
                    this.fieldsInteracted.add(fieldName);
                    gtag('event', 'form_field_interaction', {
                        form_name: 'diy_registration_step1',
                        field_name: fieldName,
                        field_type: fieldType,
                        step: 1
                    });
                    console.log('ðŸ“Š Analytics: Field interaction -', fieldName);
                }
            },
            
            trackFileUpload(fileCount, totalSize) {
                gtag('event', 'file_upload', {
                    form_name: 'diy_registration_step1',
                    file_count: fileCount,
                    total_size_mb: (totalSize / (1024 * 1024)).toFixed(2),
                    step: 1
                });
                console.log('ðŸ“Š Analytics: Files uploaded -', fileCount);
            },
            
            trackStep1Complete() {
                gtag('event', 'form_step_complete', {
                    form_name: 'diy_registration_step1',
                    step_number: 1,
                    step_name: 'contact_info',
                    fields_completed: this.fieldsInteracted.size
                });
                console.log('ðŸ“Š Analytics: Step 1 completed');
            },
            
            resetAbandonmentTimer() {
                if (this.abandonmentTimer) {
                    clearTimeout(this.abandonmentTimer);
                }
                this.abandonmentTimer = setTimeout(() => {
                    if (this.formStarted) {
                        gtag('event', 'form_abandon', {
                            form_name: 'diy_registration_step1',
                            step: 1,
                            fields_completed: this.fieldsInteracted.size
                        });
                    }
                }, 120000); // 2 minutes
            }
        };

        // ============================================
        // MOBILE MENU
        // ============================================
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');
        
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                navLinks.classList.toggle('active');
                this.textContent = navLinks.classList.contains('active') ? 'âœ•' : 'â˜°';
            });

            document.addEventListener('click', function(event) {
                if (!event.target.closest('nav')) {
                    navLinks.classList.remove('active');
                    mobileMenuBtn.textContent = 'â˜°';
                }
            });

            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function() {
                    navLinks.classList.remove('active');
                    mobileMenuBtn.textContent = 'â˜°';
                });
            });
        }

        // ============================================
        // FILE UPLOAD HANDLING
        // ============================================
        let uploadedFiles = [];
        const MAX_FILES = 12;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB per file

        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('electricityBills');
        const fileList = document.getElementById('fileList');

        // Click to upload
        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Drag and drop handlers
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const newFiles = Array.from(files);
            
            FormTracker.trackFormStart();
            FormTracker.resetAbandonmentTimer();
            
            if (uploadedFiles.length + newFiles.length > MAX_FILES) {
                alert(`You can only upload up to ${MAX_FILES} files. You currently have ${uploadedFiles.length} file(s).`);
                return;
            }

            let hasErrors = false;
            newFiles.forEach(file => {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    hasErrors = true;
                    return;
                }

                const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    alert(`File "${file.name}" has an invalid type. Please upload PDF or image files.`);
                    hasErrors = true;
                    return;
                }

                uploadedFiles.push(file);
            });

            if (!hasErrors && newFiles.length > 0) {
                const totalSize = uploadedFiles.reduce((sum, file) => sum + file.size, 0);
                FormTracker.trackFileUpload(uploadedFiles.length, totalSize);
                FormTracker.trackFieldInteraction('electricityBills', 'file');
            }

            displayFiles();
            fileInput.value = '';
        }

        function displayFiles() {
            fileList.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <div class="file-details">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                    </div>
                    <button type="button" class="file-remove" onclick="removeFile(${index})">Ã—</button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFiles();
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') return 'ðŸ“„';
            if (fileType.startsWith('image/')) return 'ðŸ–¼ï¸';
            return 'ðŸ“Ž';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ============================================
        // ATTACH ANALYTICS TO FORM FIELDS
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('step1Form');
            
            const formFields = form.querySelectorAll('input, select, textarea');
            formFields.forEach(field => {
                field.addEventListener('focus', function() {
                    FormTracker.trackFormStart();
                    FormTracker.trackFieldInteraction(this.name || this.id, this.type || this.tagName.toLowerCase());
                    FormTracker.resetAbandonmentTimer();
                });
                
                field.addEventListener('input', function() {
                    FormTracker.resetAbandonmentTimer();
                });
                
                field.addEventListener('change', function() {
                    FormTracker.resetAbandonmentTimer();
                });
            });
            
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    FormTracker.trackFieldInteraction(this.name || this.id, 'checkbox');
                    FormTracker.resetAbandonmentTimer();
                });
            });
        });

        // ============================================
        // API CONFIGURATION
        // ============================================
        
        const API_BASE_URL = 'https://3dbhitxwoc.execute-api.us-east-2.amazonaws.com/dev';
        const SIGNUP_ENDPOINT = '/auth/signup';
        const UPDATE_PROFILE_ENDPOINT = '/auth/update-profile';
        const UPLOAD_BILLS_ENDPOINT = '/admin/upload-utility-bills';
        
        // Format phone number to E.164 format
        function formatPhoneToE164(phone) {
            if (!phone) return null;
            
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 10) {
                return '+1' + digits;
            } else if (digits.length === 11 && digits.startsWith('1')) {
                return '+' + digits;
            } else if (phone.startsWith('+')) {
                return phone;
            } else if (digits.length === 11) {
                return '+' + digits;
            }
            
            return '+1' + digits;
        }
        
        // Generate a unique inverter ID
        function generateInverterId() {
            return 'INV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // ============================================
        // PRE-FILL FORM FROM SESSION STORAGE
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is returning from a later step
            const storedData = sessionStorage.getItem('registrationStep1');
            if (storedData) {
                try {
                    const step1Data = JSON.parse(storedData);
                    console.log('Pre-filling Step 1 form with saved data:', step1Data);
                    
                    // Pre-fill form fields
                    if (step1Data.fullName) document.getElementById('fullName').value = step1Data.fullName;
                    if (step1Data.email) document.getElementById('email').value = step1Data.email;
                    if (step1Data.phone) document.getElementById('phone').value = step1Data.phone;
                    if (step1Data.address) document.getElementById('address').value = step1Data.address;
                    if (step1Data.city) document.getElementById('city').value = step1Data.city;
                    if (step1Data.state) document.getElementById('state').value = step1Data.state;
                    if (step1Data.utilityCompany) document.getElementById('utilityCompany').value = step1Data.utilityCompany;
                    if (step1Data.termsAccepted) document.getElementById('terms').checked = true;
                    
                    // Load file info if any (files already uploaded to server in previous submission)
                    const storedFiles = sessionStorage.getItem('registrationFiles');
                    if (storedFiles) {
                        const filesData = JSON.parse(storedFiles);
                        // New format: {uploaded: true, files: [...]}
                        const filesList = filesData.uploaded ? filesData.files : filesData;
                        const fileCount = Array.isArray(filesList) ? filesList.length : 0;
                        if (fileCount > 0) {
                            console.log(`${fileCount} file(s) already uploaded from previous submission`);
                            // Note: Files can't be restored to input, but they're already on the server
                        }
                    }
                } catch (error) {
                    console.error('Error pre-filling Step 1 form:', error);
                }
            }
        });
        
        // Sign up new user (Step 1 only)
        async function signupUser(step1Data, filesData) {
            try {
                // Convert uploaded files data to info format
                const fileInfo = filesData.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                }));
                
                // Build the info object with step 1 data
                const info = {
                    contact: {
                        name: step1Data.fullName || null,
                        email: step1Data.email,
                        phone: step1Data.phone || null
                    },
                    location: {
                        address: step1Data.address || null,
                        city: step1Data.city,
                        state: step1Data.state
                    },
                    system: {
                        battery_capacity_kwh: null,
                        pv_wattage_kw: null,
                        installation_date: null,
                        utility_company: step1Data.utilityCompany || null,
                        serial_number: null
                    },
                    registration: {
                        mode: 'partial',
                        status: 'step1_completed',
                        vpp_participation: false,
                        marketing_consent: false,
                        terms_accepted: step1Data.termsAccepted || false,
                        registration_date: new Date().toISOString(),
                        registration_source: 'diy-web-form-step1'
                    },
                    electricity_bills: {
                        uploaded_count: fileInfo.length,
                        files: fileInfo
                    },
                    notes: null
                };
                
                // Build the API payload for signup
                const payload = {
                    entity_type: "inverter",
                    username: step1Data.fullName || null,
                    email: step1Data.email,
                    phone_number: formatPhoneToE164(step1Data.phone),
                    full_address: step1Data.address || null,
                    city: step1Data.city || null,
                    state: step1Data.state || null,
                    zip: null,
                    country: "US",
                    latitude: null,
                    longitude: null,
                    timezone: null,
                    locale: "en-US",
                    inverter_inverter_id: generateInverterId(),
                    inverter_inverter_type: "hybrid_inverter",
                    inverter_manufacturer: null,
                    inverter_serial_number: null,
                    inverter_monitoring_id: null,
                    inverter_monitoring_token: null,
                    inverter_monitoring_url: null,
                    inverter_api_key: null,
                    inverter_api_secret: null,
                    info: JSON.stringify(info),
                    site_id: null,
                    site_type: "residential",
                    installation_date: null,
                };
                
                console.log('Signing up user (Step 1):', payload);
                
                const response = await fetch(API_BASE_URL + SIGNUP_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(
                        errorData?.detail || 
                        `Signup failed with status: ${response.status}`
                    );
                }
                
                const result = await response.json();
                console.log('Signup successful, user_id:', result.user_id);
                
                // Store user_id for later use in Step 2 and Step 3
                if (result.user_id) {
                    sessionStorage.setItem('registrationUserId', result.user_id);
                }
                
                return { success: true, result };
            } catch (error) {
                console.error('Error signing up user:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Update existing user profile (Step 1 - when returning from later steps)
        async function updateProfileStep1(step1Data, filesData) {
            try {
                const userId = sessionStorage.getItem('registrationUserId');
                if (!userId) {
                    throw new Error('No user_id found for profile update.');
                }
                
                // Convert uploaded files data to info format
                const fileInfo = filesData.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type
                }));
                
                // Build the info object with step 1 data
                const info = {
                    contact: {
                        name: step1Data.fullName || null,
                        email: step1Data.email,
                        phone: step1Data.phone || null
                    },
                    location: {
                        address: step1Data.address || null,
                        city: step1Data.city,
                        state: step1Data.state
                    },
                    system: {
                        battery_capacity_kwh: null,
                        pv_wattage_kw: null,
                        installation_date: null,
                        utility_company: step1Data.utilityCompany || null,
                        serial_number: null
                    },
                    registration: {
                        mode: 'partial',
                        status: 'step1_updated',
                        vpp_participation: false,
                        marketing_consent: false,
                        terms_accepted: step1Data.termsAccepted || false,
                        registration_date: new Date().toISOString(),
                        registration_source: 'diy-web-form-step1'
                    },
                    electricity_bills: {
                        uploaded_count: fileInfo.length,
                        files: fileInfo
                    },
                    notes: null
                };
                
                // Build the API payload for profile update
                const payload = {
                    account_id: userId,
                    entity_type: "inverter",
                    username: step1Data.fullName || null,
                    email: step1Data.email,
                    phone_number: formatPhoneToE164(step1Data.phone),
                    full_address: step1Data.address || null,
                    city: step1Data.city || null,
                    state: step1Data.state || null,
                    zip: null,
                    country: "US",
                    latitude: null,
                    longitude: null,
                    timezone: null,
                    locale: "en-US",
                    inverter_inverter_id: null, // Don't change inverter_id if already set
                    inverter_inverter_type: "hybrid_inverter",
                    inverter_manufacturer: null,
                    inverter_serial_number: null,
                    inverter_monitoring_id: null,
                    inverter_monitoring_token: null,
                    inverter_monitoring_url: null,
                    inverter_api_key: null,
                    inverter_api_secret: null,
                    info: JSON.stringify(info),
                    site_id: null,
                    site_type: "residential",
                    installation_date: null,
                };
                
                console.log('Updating profile (Step 1) for user_id:', userId, payload);
                
                const response = await fetch(API_BASE_URL + UPDATE_PROFILE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(
                        errorData?.detail || 
                        `Profile update failed with status: ${response.status}`
                    );
                }
                
                const result = await response.json();
                console.log('Profile updated successfully (Step 1):', result);
                
                return { success: true, result };
            } catch (error) {
                console.error('Error updating profile (Step 1):', error);
                return { success: false, error: error.message };
            }
        }
        
        // Get pre-signed URLs from the API
        async function getPresignedUrls(userId, files) {
            const filesMetadata = files.map(file => ({
                filename: file.name,
                content_type: file.type || 'application/octet-stream'
            }));
            
            console.log(`Requesting pre-signed URLs for ${files.length} file(s)...`);
            
            const response = await fetch(API_BASE_URL + UPLOAD_BILLS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    account_id: userId,
                    files: filesMetadata
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.detail || `Failed to get upload URLs: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // Upload a single file to S3 using pre-signed URL
        async function uploadFileToS3(file, presignedInfo, fileNum, totalFiles) {
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            console.log(`Uploading file ${fileNum}/${totalFiles}: ${file.name} (${fileSizeMB}MB) to S3...`);
            
            // Debug logging
            console.log('=== DEBUG: S3 Upload Details ===');
            console.log('Pre-signed URL:', presignedInfo.presigned_url);
            console.log('Pre-signed fields:', JSON.stringify(presignedInfo.presigned_fields, null, 2));
            console.log('File name:', file.name);
            console.log('File size:', file.size, 'bytes');
            console.log('File type:', file.type);
            console.log('================================');

            // Build form data with all required fields from pre-signed URL
            const formData = new FormData();
            
            // Add all the pre-signed fields first (order matters for S3)
            for (const [key, value] of Object.entries(presignedInfo.presigned_fields)) {
                formData.append(key, value);
                console.log(`FormData field: ${key} = ${value.substring ? value.substring(0, 50) + '...' : value}`);
            }
            
            // Add the file last (required by S3)
            formData.append('file', file);
            console.log('FormData file appended:', file.name);

            // Create abort controller with 10-minute timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log('!!! TIMEOUT TRIGGERED - aborting request');
                controller.abort();
            }, 10 * 60 * 1000); // 10 minutes
            
            const startTime = Date.now();
            console.log('Starting fetch to S3 at:', new Date().toISOString());
            
            try {
                const response = await fetch(presignedInfo.presigned_url, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                console.log(`Fetch completed in ${elapsed}s, status: ${response.status}`);

                // S3 returns 204 on success for pre-signed POST
                if (!response.ok && response.status !== 204) {
                    const errorText = await response.text().catch(() => '');
                    console.error('S3 error response:', errorText);
                    throw new Error(`S3 upload failed: ${response.status} - ${errorText}`);
                }

                console.log(`File ${fileNum} uploaded successfully to: ${presignedInfo.s3_key}`);
                return { success: true, s3_key: presignedInfo.s3_key };
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    throw new Error(`File ${fileNum} (${file.name}) upload timed out after 10 minutes`);
                }
                console.warn(`S3 upload failed for file ${fileNum}: ${error.message}`);
                throw error;
            }
        }
        
        // Legacy function for backwards compatibility
        async function uploadSingleFile(userId, file, fileNum, totalFiles) {
            // Get pre-signed URL for this single file
            const presignedResponse = await getPresignedUrls(userId, [file]);
            
            if (presignedResponse.failed_files?.length > 0) {
                throw new Error(presignedResponse.failed_files[0].error || 'Failed to get upload URL');
            }
            
            if (!presignedResponse.presigned_urls?.length) {
                throw new Error('No pre-signed URL returned from server');
            }
            
            return await uploadFileToS3(file, presignedResponse.presigned_urls[0], fileNum, totalFiles);
        }
        
        // Upload all files - get all pre-signed URLs at once, then upload
        async function uploadAllFiles(userId, files) {
            const totalSize = files.reduce((sum, f) => sum + f.size, 0);
            console.log(`Uploading all ${files.length} file(s) (${(totalSize / 1024 / 1024).toFixed(2)}MB) using pre-signed URLs`);
            
            // Get pre-signed URLs for all files
            const presignedResponse = await getPresignedUrls(userId, files);
            
            if (presignedResponse.failed_files?.length > 0) {
                console.warn('Some files failed to get pre-signed URLs:', presignedResponse.failed_files);
            }
            
            // Upload each file to S3
            const results = [];
            for (let i = 0; i < presignedResponse.presigned_urls.length; i++) {
                const presignedInfo = presignedResponse.presigned_urls[i];
                const file = files.find(f => f.name === presignedInfo.filename);
                
                if (file) {
                    const result = await uploadFileToS3(file, presignedInfo, i + 1, presignedResponse.presigned_urls.length);
                    results.push(result);
                }
            }
            
            return {
                success: true,
                uploaded: results,
                failed: presignedResponse.failed_files || []
            };
        }
        
        // Upload utility bills using S3 pre-signed URLs
        async function uploadUtilityBills(userId, files, onProgress) {
            if (!files || files.length === 0) {
                console.log('No utility bills to upload');
                return { success: true, message: 'No files to upload', uploadedFiles: [], failedFiles: [], errors: [] };
            }

            const uploadedFiles = [];
            const failedFiles = [];
            const errors = [];
            
            // Check if we can use ZIP compression (reduces number of uploads)
            if (files.length > 1 && window.JSZip) {
                try {
                    console.log('Preparing to upload files as single ZIP...');
                    
                    const zip = new JSZip();
                    Array.from(files).forEach(file => {
                        zip.file(file.name, file);
                    });
                    
                    const zipBlob = await zip.generateAsync({
                        type: "blob",
                        compression: "DEFLATE",
                        compressionOptions: { level: 6 }
                    });
                    
                    console.log(`ZIP created: ${(zipBlob.size/1024/1024).toFixed(2)}MB`);
                    
                    if (zipBlob.size < 50 * 1024 * 1024) { // 50MB limit (S3 pre-signed URL limit)
                        const zipFile = new File([zipBlob], `utility_bills_${Date.now()}.zip`, { type: "application/zip" });
                        
                        if (onProgress) onProgress(0, 1, 0, 1);
                        
                        // Get pre-signed URL and upload the ZIP
                        await uploadSingleFile(userId, zipFile, 1, 1);
                        
                        // Mark all original files as uploaded
                        uploadedFiles.push(...files);
                        console.log(`ZIP upload successful`);
                        
                        return {
                            success: true,
                            partial: false,
                            uploadedFiles,
                            failedFiles: [],
                            errors: [],
                            message: `All files uploaded as ZIP`
                        };
                    } else {
                        console.warn(`ZIP is too large (>50MB), will upload files individually`);
                    }
                } catch (zipError) {
                    console.warn(`ZIP upload failed:`, zipError.message);
                    // Fallthrough to individual upload logic below
                }
            }

            // Upload files individually using pre-signed URLs
            console.log(`Uploading ${files.length} file(s) individually using pre-signed URLs...`);
            
            try {
                // Get all pre-signed URLs at once (more efficient)
                const presignedResponse = await getPresignedUrls(userId, files);
                
                // Handle files that failed to get pre-signed URLs
                if (presignedResponse.failed_files?.length > 0) {
                    for (const failed of presignedResponse.failed_files) {
                        const file = files.find(f => f.name === failed.filename);
                        if (file) {
                            failedFiles.push(file);
                            errors.push(`${failed.filename}: ${failed.error}`);
                        }
                    }
                }
                
                // Upload each file to S3
                const presignedUrls = presignedResponse.presigned_urls || [];
                for (let i = 0; i < presignedUrls.length; i++) {
                    const presignedInfo = presignedUrls[i];
                    const file = files.find(f => f.name === presignedInfo.filename);
                    
                    if (!file) continue;
                    
                    if (onProgress) onProgress(i, presignedUrls.length, uploadedFiles.length, files.length);
                    
                    try {
                        await uploadFileToS3(file, presignedInfo, i + 1, presignedUrls.length);
                        uploadedFiles.push(file);
                    } catch (error) {
                        failedFiles.push(file);
                        errors.push(`${file.name}: ${error.message}`);
                    }
                }
                
            } catch (error) {
                // Failed to get pre-signed URLs entirely
                console.error('Failed to get pre-signed URLs:', error);
                errors.push(`Failed to get upload URLs: ${error.message}`);
                failedFiles.push(...files.filter(f => !uploadedFiles.includes(f)));
            }
            
            return {
                success: failedFiles.length === 0,
                partial: uploadedFiles.length > 0 && failedFiles.length > 0,
                uploadedFiles,
                failedFiles,
                errors,
                message: failedFiles.length === 0 
                    ? `All ${uploadedFiles.length} files uploaded successfully`
                    : `${uploadedFiles.length} files uploaded, ${failedFiles.length} failed`
            };
        }
        
        // ============================================
        // FORM SUBMIT HANDLER - SAVE TO SESSION STORAGE AND BACKEND
        // ============================================
        
        document.getElementById('step1Form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Validate required fields
            const requiredFields = this.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (field.offsetParent !== null && !field.value.trim()) {
                    field.style.borderColor = '#ef4444';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e5e7eb';
                }
            });
            
            if (!isValid) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Prepare data to save
            const step1Data = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phone: formData.get('phone') || null,
                address: formData.get('address') || null,
                city: formData.get('city'),
                state: formData.get('state'),
                utilityCompany: formData.get('utilityCompany') || null,
                termsAccepted: formData.get('terms') === 'on',
                timestamp: new Date().toISOString()
            };
            
            // Save to session storage
            sessionStorage.setItem('registrationStep1', JSON.stringify(step1Data));
            
            // Prepare file metadata (without dataURL to avoid sessionStorage quota issues)
            const filesData = uploadedFiles.map(file => ({
                name: file.name,
                size: file.size,
                type: file.type
            }));
            
            // Track step 1 completion
            FormTracker.trackStep1Complete();
            
            console.log('Step 1 data saved to session:', step1Data);
            
            // Check if user_id exists to determine if we should signup or update profile
            const existingUserId = sessionStorage.getItem('registrationUserId');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            
            let apiResult;
            
            if (existingUserId) {
                // User is returning from a later step - update existing profile
                console.log('User ID found - updating existing profile');
                submitBtn.textContent = 'Updating your information...';
                apiResult = await updateProfileStep1(step1Data, filesData);
            } else {
                // New user - create account
                console.log('No User ID found - creating new account');
                submitBtn.textContent = 'Creating your account...';
                apiResult = await signupUser(step1Data, filesData);
            }
            
            if (!apiResult.success) {
                // Show error but allow user to continue (data is in sessionStorage)
                const actionText = existingUserId ? 'updating your profile' : 'creating your account';
                alert(
                    'âš ï¸ Account ' + (existingUserId ? 'Update' : 'Creation') + ' Issue\n\n' +
                    'We encountered an issue ' + actionText + ':\n' +
                    apiResult.error + '\n\n' +
                    'You can continue, but please contact support@microvpp.com if this persists.'
                );
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save & Continue to Step 2 â†’';
                return;
            }
            
            // Upload files directly to server (one by one if total > 5MB)
            const userId = apiResult.result?.user_id || existingUserId;
            if (uploadedFiles.length > 0 && userId) {
                const totalFileSize = uploadedFiles.reduce((sum, f) => sum + f.size, 0);
                const totalFileSizeMB = (totalFileSize / 1024 / 1024).toFixed(1);
                
                // Inform user about large upload
                if (totalFileSize > 5 * 1024 * 1024) {
                    console.log(`Large upload detected (${totalFileSizeMB}MB), will upload files one by one`);
                }
                
                submitBtn.textContent = 'Uploading utility bills...';
                
                // Progress callback to update button text
                const onProgress = (batchIndex, totalBatches, filesUploaded, totalFiles) => {
                    const percent = Math.round((filesUploaded / totalFiles) * 100);
                    submitBtn.textContent = `Uploading utility bills (${percent}%)...`;
                };
                
                const uploadResult = await uploadUtilityBills(userId, uploadedFiles, onProgress);
                
                if (uploadResult.success) {
                    // All files uploaded successfully
                    sessionStorage.setItem('registrationFiles', JSON.stringify({
                        uploaded: true,
                        files: filesData
                    }));
                    console.log(`All ${uploadedFiles.length} files uploaded successfully`);
                } else if (uploadResult.partial) {
                    // Some files uploaded, some failed
                    console.warn(`Partial upload: ${uploadResult.uploadedFiles.length} succeeded, ${uploadResult.failedFiles.length} failed`);
                    
                    // Store info about uploaded files
                    const uploadedFilesData = uploadResult.uploadedFiles.map(f => ({
                        name: f.name, size: f.size, type: f.type
                    }));
                    
                    // Try to store failed files as dataURLs for step 2
                    const failedFilesSize = uploadResult.failedFiles.reduce((sum, f) => sum + f.size, 0);
                    const maxStorageSize = 4 * 1024 * 1024; // 4MB limit
                    
                    if (failedFilesSize < maxStorageSize) {
                        try {
                            submitBtn.textContent = 'Preparing remaining files...';
                            const failedFilesWithData = [];
                            for (const file of uploadResult.failedFiles) {
                                const dataURL = await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onload = (e) => resolve(e.target.result);
                                    reader.readAsDataURL(file);
                                });
                                failedFilesWithData.push({
                                    name: file.name, size: file.size, type: file.type, dataURL
                                });
                            }
                            sessionStorage.setItem('registrationFiles', JSON.stringify({
                                uploaded: 'partial',
                                uploadedFiles: uploadedFilesData,
                                pendingFiles: failedFilesWithData
                            }));
                        } catch (e) {
                            sessionStorage.setItem('registrationFiles', JSON.stringify({
                                uploaded: 'partial',
                                uploadedFiles: uploadedFilesData,
                                needsReupload: true,
                                failedFileNames: uploadResult.failedFiles.map(f => f.name)
                            }));
                            const errorDetails = uploadResult.errors?.length > 0 
                                ? `\n\nErrors:\n${uploadResult.errors.slice(0, 3).join('\n')}${uploadResult.errors.length > 3 ? '\n...' : ''}`
                                : '';
                            alert(`âš ï¸ ${uploadResult.uploadedFiles.length} files uploaded.\n\n${uploadResult.failedFiles.length} files failed to upload.${errorDetails}\n\nPlease re-select them in Step 2.`);
                        }
                    } else {
                        sessionStorage.setItem('registrationFiles', JSON.stringify({
                            uploaded: 'partial',
                            uploadedFiles: uploadedFilesData,
                            needsReupload: true,
                            failedFileNames: uploadResult.failedFiles.map(f => f.name)
                        }));
                        const errorDetails = uploadResult.errors?.length > 0 
                            ? `\n\nErrors:\n${uploadResult.errors.slice(0, 3).join('\n')}${uploadResult.errors.length > 3 ? '\n...' : ''}`
                            : '';
                        alert(`âš ï¸ ${uploadResult.uploadedFiles.length} files uploaded.\n\n${uploadResult.failedFiles.length} files failed to upload.${errorDetails}\n\nPlease re-select them in Step 2.`);
                    }
                } else {
                    // All files failed to upload
                    console.warn('All file uploads failed:', uploadResult.error);
                    
                    // Try to store files as dataURLs for step 2 (with size limit check)
                    const totalSize = uploadedFiles.reduce((sum, f) => sum + f.size, 0);
                    const maxStorageSize = 4 * 1024 * 1024; // 4MB limit for safety
                    
                    if (totalSize < maxStorageSize) {
                        try {
                            submitBtn.textContent = 'Preparing files for next step...';
                            const filesWithData = [];
                            for (const file of uploadedFiles) {
                                const dataURL = await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onload = (e) => resolve(e.target.result);
                                    reader.readAsDataURL(file);
                                });
                                filesWithData.push({
                                    name: file.name, size: file.size, type: file.type, dataURL
                                });
                            }
                            sessionStorage.setItem('registrationFiles', JSON.stringify({
                                uploaded: false,
                                files: filesWithData
                            }));
                            console.log('Files stored for upload in Step 2');
                        } catch (storageError) {
                            console.warn('Could not store files:', storageError);
                            sessionStorage.setItem('registrationFiles', JSON.stringify({
                                uploaded: false,
                                needsReupload: true,
                                files: filesData
                            }));
                            alert('âš ï¸ File Upload Notice\n\nWe couldn\'t upload your utility bills yet. Please re-select them in the next step.');
                        }
                    } else {
                        // Files too large to store - user needs to re-select in step 2
                        sessionStorage.setItem('registrationFiles', JSON.stringify({
                            uploaded: false,
                            needsReupload: true,
                            files: filesData
                        }));
                        alert('âš ï¸ File Upload Notice\n\nYour utility bills are too large to transfer between steps. Please re-select them in Step 2.');
                    }
                }
            }
            
            // Continue to step 2
            console.log('Redirecting to Step 2...');
            window.location.href = 'diy-registration-step2.html';
        });
    </script>
</body>
</html>
