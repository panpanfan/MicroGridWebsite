<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-05XLDKW0MN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-05XLDKW0MN');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Electricity Bills - Step 3 - MicroGrid</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        :root {
            --brand-green: #10B981;
            --brand-green-dark: #065f46;
            --brand-green-medium: #059669;
            --brand-green-darker: #047857;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            padding: 1rem 0;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(16, 185, 129, 0.15);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #10B981;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cta-button {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .cta-button:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .cta-button-outline {
            background: transparent;
            color: var(--brand-green);
            padding: 0.5rem 1rem;
            border: 2px solid var(--brand-green);
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .cta-button-outline:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #6b7280;
        }

        /* Registration form section */
        .registration-form-section {
            padding: 140px 0 80px;
            background: #f8fafc;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 16.66%;
            right: 16.66%;
            height: 3px;
            background: #10B981;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .progress-step.completed .progress-step-circle {
            background: #10B981;
            color: white;
        }

        .progress-step.active .progress-step-circle {
            background: #10B981;
            color: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .progress-step-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-step.active .progress-step-label {
            color: #059669;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .submit-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .back-btn {
            background: transparent;
            color: #6b7280;
            padding: 1rem 2rem;
            border: 2px solid #e5e7eb;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .back-btn:hover {
            border-color: #059669;
            color: #059669;
        }

        .file-upload-container {
            margin-top: 0.5rem;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #059669;
            background: #f0fdf4;
        }

        .file-upload-area.drag-over {
            border-color: #059669;
            background: #ecfdf5;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .upload-subtext {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: #059669;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .file-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .file-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            color: #333;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                padding: 1rem;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                gap: 0;
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links li {
                padding: 0.75rem 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .nav-links li:last-child {
                border-bottom: none;
            }

            .form-container {
                padding: 2rem 1.5rem;
                margin: 0 1rem;
            }

            .progress-bar::before {
                left: 15%;
                right: 15%;
            }
        }

        @media (max-width: 640px) {
            .cta-button.hide-mobile {
                display: none;
            }
        }

        /* Footer */
        footer {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: white;
            padding: 2.5rem 0;
            border-top: 1px solid rgba(16, 185, 129, 0.1);
        }

        .footer-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: var(--brand-green);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .footer-logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .footer-logo-title {
            font-weight: 800;
            font-size: 1rem;
        }

        .footer-logo-subtitle {
            font-size: 0.875rem;
            color: #9CA3AF;
        }

        .footer-tagline {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            letter-spacing: -0.015em;
        }

        .footer-nav {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .footer-nav a {
            color: #9CA3AF;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-nav a:hover {
            color: white;
        }

        .footer-copyright {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            text-align: center;
        }

        .footer-copyright p {
            font-size: 0.875rem;
            color: #9CA3AF;
            margin: 0;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="container">
            <a href="index.html" class="logo">
                <img src="assets/images/microgrid_logo.png" alt="MicroGrid" height="50">
            </a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#join-movement">How It Works</a></li>
                <li><a href="index.html#nem">California (NEM 3.0)</a></li>
                <li><a href="index.html#impact">Results</a></li>
                <li><a href="index.html#compat">Compatibility</a></li>
                <li><a href="index.html#faq">FAQ</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="header-buttons">
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>
                <a href="https://apps.apple.com/us/app/dgrid/id6747276150" class="cta-button-outline">Download App</a>
            </div>
        </nav>
    </header>

    <!-- Registration Form Section -->
    <section class="registration-form-section">
        <div class="container">
            <div class="form-container">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-step completed">
                        <div class="progress-step-circle">‚úì</div>
                        <div class="progress-step-label">Contact Info</div>
                    </div>
                    <div class="progress-step completed">
                        <div class="progress-step-circle">‚úì</div>
                        <div class="progress-step-label">System Setup</div>
                    </div>
                    <div class="progress-step active">
                        <div class="progress-step-circle">3</div>
                        <div class="progress-step-label">Electricity Bills</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2>Step 3 ‚Äî Upload Your Electricity Bills</h2>
                    <p>Help us calculate your personalized savings estimate</p>
                </div>

                <form id="diyForm" action="#" method="POST">
                    
                    <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üìä</span>
                            <div>
                                <h3 style="font-size: 1.1rem; color: #1e40af; font-weight: 700; margin-bottom: 0.5rem;">Why We Need Your Bills</h3>
                                <p style="color: #1e3a8a; font-size: 0.95rem; line-height: 1.6; margin: 0;">
                                    Since you're using the system specs approach, we need your recent electricity bills to analyze your usage patterns and calculate accurate savings estimates. Our AI will process your bills to understand your consumption and determine your earning potential.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="electricityBills">Upload Recent Electricity Bills *</label>
                        <div class="file-upload-container">
                            <div class="file-upload-area" id="fileUploadArea">
                                <div class="upload-icon">üìÑ</div>
                                <p class="upload-text">Click to upload or drag and drop</p>
                                <p class="upload-subtext">Upload 1-12 files (PDF or images) ‚Äî more recent bills provide better estimates</p>
                                <input type="file" id="electricityBills" name="electricityBills" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;">
                            </div>
                            <div id="fileList" class="file-list"></div>
                        </div>
                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                            <strong style="color: #ef4444;">Required:</strong> Please upload at least one recent bill. We recommend uploading the last 3-12 months for the most accurate estimates.
                        </small>
                    </div>

                    <p style="text-align: center; margin: 1.5rem 0 0.75rem 0; padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border-radius: 12px; border: 2px solid #10B981;">
                        <span style="display: block; color: #059669; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">üéÅ UNLOCK YOUR EARNING POTENTIAL</span>
                        <span style="display: block; color: #047857; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Typical range for similar systems: $50‚Äì$200/month</span>
                        <span style="display: block; color: #6b7280; font-size: 0.85rem;">Get your personalized estimate ‚Üì</span>
                    </p>

                    <button type="button" class="back-btn" onclick="window.location.href='diy-registration-step2.html'">‚Üê Back to Step 2</button>
                    <button type="submit" class="submit-btn" id="submitBtn" disabled>Complete Registration</button>
                    
                    <p style="text-align: center; margin-top: 1rem; color: #6b7280; font-size: 0.95rem;" id="submitHelpText">üí° You'll receive your results within 24 hours.</p>

                    <div style="text-align: center; margin-top: 1.25rem;">
                        <a href="mailto:support@microvpp.com" style="display: inline-block; padding: 0.75rem 1.5rem; background: #f0fdf4; color: #059669; text-decoration: none; font-weight: 600; border-radius: 8px; border: 2px solid #10B981; transition: all 0.3s ease;">
                            üí¨ Need help? Contact Support
                        </a>
                    </div>

                    <small style="display: block; text-align: center; margin-top: 1.5rem; color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                        By continuing you agree to our <a href="privacy.html" style="color: #059669;">Privacy Policy</a>.  
                        We only read system data to generate savings; we never sell personal data.
                    </small>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="footer-logo-icon"></span>
                    <div class="footer-logo-text">
                        <div class="footer-logo-title">MicroVPP‚Ñ¢</div>
                        <div class="footer-logo-subtitle">by MicroGrid</div>
                    </div>
                </div>
                <div class="footer-tagline">Smarter homes. Stronger grids.</div>
                <nav class="footer-nav">
                    <a href="index.html">Home</a>
                    <a href="about.html">About</a>
                    <a href="privacy.html">Privacy</a>
                    <a href="terms.html">Terms</a>
                    <a href="mailto:info@microvpp.com">Contact</a>
                </nav>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2025 MicroGrid LLC. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // MOBILE MENU
        // ============================================
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');
        
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                navLinks.classList.toggle('active');
                this.textContent = navLinks.classList.contains('active') ? '‚úï' : '‚ò∞';
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('nav')) {
                    navLinks.classList.remove('active');
                    mobileMenuBtn.textContent = '‚ò∞';
                }
            });

            // Close menu when clicking a link
            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function() {
                    navLinks.classList.remove('active');
                    mobileMenuBtn.textContent = '‚ò∞';
                });
            });
        }

        // ============================================
        // LOAD PREVIOUS STEP DATA FROM SESSION STORAGE
        // ============================================
        
        let step1Data = {};
        let step2Data = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load step 1 data
            const storedStep1 = sessionStorage.getItem('registrationStep1');
            if (!storedStep1) {
                alert('‚ö†Ô∏è No data from Step 1 found. Redirecting back to Step 1...');
                window.location.href = 'diy-registration.html';
                return;
            }
            
            // Load step 2 data
            const storedStep2 = sessionStorage.getItem('registrationStep2');
            if (!storedStep2) {
                alert('‚ö†Ô∏è No data from Step 2 found. Redirecting back to Step 2...');
                window.location.href = 'diy-registration-step2.html';
                return;
            }
            
            try {
                step1Data = JSON.parse(storedStep1);
                step2Data = JSON.parse(storedStep2);
                console.log('Loaded Step 1 data:', step1Data);
                console.log('Loaded Step 2 data:', step2Data);
            } catch (error) {
                console.error('Error loading previous step data:', error);
                alert('‚ö†Ô∏è Error loading data from previous steps. Please start over.');
                window.location.href = 'diy-registration.html';
                return;
            }
        });

        // ============================================
        // API CONFIGURATION
        // ============================================
        
        const API_BASE_URL = 'https://3dbhitxwoc.execute-api.us-east-2.amazonaws.com/dev';
        const REGISTER_ENDPOINT = '/auth/signup';
        const UPLOAD_BILLS_ENDPOINT = '/admin/upload-utility-bills';

        // ============================================
        // FILE UPLOAD HANDLING
        // ============================================
        let uploadedFiles = [];
        const MAX_FILES = 12;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB per file

        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('electricityBills');
        const fileList = document.getElementById('fileList');
        const submitBtn = document.getElementById('submitBtn');

        // Click to upload
        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Drag and drop handlers
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const newFiles = Array.from(files);
            
            if (uploadedFiles.length + newFiles.length > MAX_FILES) {
                alert(`You can only upload up to ${MAX_FILES} files. You currently have ${uploadedFiles.length} file(s).`);
                return;
            }

            let hasErrors = false;
            newFiles.forEach(file => {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    hasErrors = true;
                    return;
                }

                const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    alert(`File "${file.name}" has an invalid type. Please upload PDF or image files.`);
                    hasErrors = true;
                    return;
                }

                uploadedFiles.push(file);
            });

            displayFiles();
            updateSubmitButton();
            fileInput.value = '';
        }

        function displayFiles() {
            fileList.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <div class="file-details">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                    </div>
                    <button type="button" class="file-remove" onclick="removeFile(${index})">√ó</button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFiles();
            updateSubmitButton();
        }

        function updateSubmitButton() {
            // Enable submit button only if at least one file is uploaded
            if (uploadedFiles.length > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') return 'üìÑ';
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            return 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Generate a unique inverter ID
        function generateInverterId() {
            return 'INV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Format phone number to E.164 format
        function formatPhoneToE164(phone) {
            if (!phone) return null;
            
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 10) {
                return '+1' + digits;
            } else if (digits.length === 11 && digits.startsWith('1')) {
                return '+' + digits;
            } else if (phone.startsWith('+')) {
                return phone;
            } else if (digits.length === 11) {
                return '+' + digits;
            }
            
            return '+1' + digits;
        }

        // Convert files to data URLs for later upload
        async function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    dataURL: e.target.result
                });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Convert data URL back to File for upload
        async function dataURLtoFile(dataurl, filename, type) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type: mime});
        }

        // Map form data to API payload
        async function mapFormToPayload() {
            const manufacturer = step2Data.inverterManufacturer;
            const otherManufacturer = step2Data.otherManufacturer;
            const inverterId = generateInverterId();
            
            // Determine the inverter type
            const inverterManufacturer = manufacturer === 'Other' && otherManufacturer 
                ? otherManufacturer 
                : manufacturer;

            // Convert uploaded files to data URLs for storage
            const fileData = [];
            for (const file of uploadedFiles) {
                const dataURL = await fileToDataURL(file);
                fileData.push(dataURL);
            }

            // Build the info object with all additional user and system information
            const info = {
                contact: {
                    name: step1Data.fullName || null,
                    email: step1Data.email,
                    phone: step1Data.phone || null
                },
                location: {
                    address: step1Data.address || null,
                    city: step1Data.city,
                    state: step1Data.state
                },
                system: {
                    battery_capacity_kwh: step2Data.batteryCapacity ? parseFloat(step2Data.batteryCapacity) : null,
                    pv_wattage_kw: step2Data.pvWattage ? parseFloat(step2Data.pvWattage) : null,
                    installation_date: step2Data.installationDate || null,
                    utility_company: step1Data.utilityCompany || null,
                    serial_number: step2Data.serialNumber || null
                },
                registration: {
                    mode: 'simulation',
                    vpp_participation: step2Data.vppParticipation || false,
                    marketing_consent: step2Data.marketing || false,
                    terms_accepted: step1Data.termsAccepted || false,
                    registration_date: new Date().toISOString(),
                    registration_source: 'diy-web-form-step3'
                },
                electricity_bills: {
                    uploaded_count: fileData.length,
                    files: fileData.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    }))
                },
                notes: step2Data.additionalNotes || null
            };

            // Build the API payload
            const payload = {
                entity_type: "inverter",
                username: step1Data.fullName || null,
                email: step1Data.email,
                phone_number: formatPhoneToE164(step1Data.phone),
                full_address: step1Data.address || null,
                city: step1Data.city || null,
                state: step1Data.state || null,
                zip: step1Data.zip || null,
                country: "US",
                latitude: null,
                longitude: null,
                timezone: null,
                locale: "en-US",
                inverter_inverter_id: inverterId,
                inverter_inverter_type: "hybrid_inverter",
                inverter_manufacturer: inverterManufacturer,
                inverter_serial_number: step2Data.serialNumber,
                inverter_monitoring_id: null,
                inverter_monitoring_token: null,
                inverter_monitoring_url: null,
                inverter_api_key: null,
                inverter_api_secret: null,
                info: JSON.stringify(info),
                site_id: null,
                site_type: "residential",
                installation_date: step2Data.installationDate || null,
            };

            return { payload, fileData };
        }

        // Upload utility bills using the user_id from signup
        async function uploadUtilityBills(userId, fileData) {
            if (!fileData || fileData.length === 0) {
                console.log('No utility bills to upload');
                return { success: true, message: 'No files to upload' };
            }

            try {
                const formData = new FormData();
                formData.append('account_id', userId);
                
                // Convert data URLs back to File objects
                for (const data of fileData) {
                    const file = await dataURLtoFile(data.dataURL, data.name, data.type);
                    formData.append('files', file);
                }
                
                console.log(`Uploading ${fileData.length} utility bill(s) for account_id: ${userId}`);

                const response = await fetch(API_BASE_URL + UPLOAD_BILLS_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(
                        errorData?.detail || 
                        `Utility bill upload failed with status: ${response.status}`
                    );
                }

                const result = await response.json();
                console.log('Utility bills uploaded successfully:', result);
                
                return { success: true, result };
            } catch (error) {
                console.error('Utility bill upload error:', error);
                return { success: false, error: error.message };
            }
        }

        // Submit form to API
        async function submitRegistration(payload, fileData) {
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing Your Registration...';
                submitBtn.style.opacity = '0.7';

                const response = await fetch(API_BASE_URL + REGISTER_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(
                        errorData?.detail || 
                        `Registration failed with status: ${response.status}`
                    );
                }

                const result = await response.json();
                console.log('Registration successful:', result);

                // Upload utility bills
                if (fileData.length > 0 && result.user_id) {
                    submitBtn.textContent = 'Uploading Utility Bills...';
                    const uploadResult = await uploadUtilityBills(result.user_id, fileData);
                    
                    if (!uploadResult.success) {
                        console.warn('Utility bill upload failed, but registration succeeded:', uploadResult.error);
                        alert(
                            '‚ö†Ô∏è Warning: Registration successful, but bill upload encountered an issue.\n\n' +
                            'We\'ll contact you to collect your bills. You can also email them to support@microvpp.com.'
                        );
                    }
                }

                // Build success message
                let successMessage = 'üéâ Success! We\'re preparing your savings estimate!\n\n';
                successMessage += `We've received ${fileData.length} electricity bill file(s) for analysis.\n\n`;
                successMessage += 
                    'What happens next:\n' +
                    '1. Our AI analyzes your utility bills and system specs\n' +
                    '2. You\'ll receive a detailed savings estimate within 24 hours\n' +
                    '3. We\'ll email instructions to connect your actual system\n' +
                    '4. Download the MicroVPP‚Ñ¢ app to view your results\n\n' +
                    'Check your email (' + payload.email + ') for your savings estimate!';

                // Show success message
                alert(successMessage);

                // Clear session storage
                sessionStorage.removeItem('registrationStep1');
                sessionStorage.removeItem('registrationStep2');

                // Redirect to home
                window.location.href = 'index.html';

            } catch (error) {
                console.error('Registration error:', error);
                
                // Show error message
                alert(
                    '‚ùå Registration Error\n\n' +
                    'We encountered an issue while processing your registration:\n' +
                    error.message + '\n\n' +
                    'Please try again or contact support@microvpp.com for assistance.'
                );
            } finally {
                // Restore button state
                submitBtn.disabled = uploadedFiles.length === 0;
                submitBtn.textContent = originalText;
                submitBtn.style.opacity = '1';
            }
        }

        // Form submit handler
        document.getElementById('diyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate that at least one file is uploaded
            if (uploadedFiles.length === 0) {
                alert('‚ö†Ô∏è Please upload at least one electricity bill to continue.\n\nYour bills help us calculate accurate savings estimates.');
                return;
            }
            
            try {
                const { payload, fileData } = await mapFormToPayload();
                console.log('Sending registration payload:', payload);
                await submitRegistration(payload, fileData);
            } catch (error) {
                console.error('Form submission error:', error);
                alert('An error occurred while preparing your registration. Please try again.');
            }
        });
    </script>
</body>
</html>

