<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-05XLDKW0MN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-05XLDKW0MN');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Setup - Step 1 - MicroGrid</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        :root {
            --brand-green: #10B981;
            --brand-green-dark: #065f46;
            --brand-green-medium: #059669;
            --brand-green-darker: #047857;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            padding: 1rem 0;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(16, 185, 129, 0.15);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #10B981;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cta-button {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .cta-button:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .cta-button-outline {
            background: transparent;
            color: var(--brand-green);
            padding: 0.5rem 1rem;
            border: 2px solid var(--brand-green);
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .cta-button-outline:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #6b7280;
        }

        /* Registration form section */
        .registration-form-section {
            padding: 140px 0 80px;
            background: #f8fafc;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 16.5%;
            right: 16.5%;
            height: 3px;
            background: #10B981;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .progress-step.completed .progress-step-circle {
            background: #10B981;
            color: white;
        }

        .progress-step.active .progress-step-circle {
            background: #10B981;
            color: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .progress-step-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-step.active .progress-step-label {
            color: #059669;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-top: 0.25rem;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: 400;
            line-height: 1.5;
        }

        .submit-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        .back-btn {
            background: transparent;
            color: #6b7280;
            padding: 1rem 2rem;
            border: 2px solid #e5e7eb;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .back-btn:hover {
            border-color: #059669;
            color: #059669;
        }

        .file-upload-area:hover {
            border-color: #059669 !important;
            background: #f0fdf4 !important;
        }

        .file-upload-area.drag-over {
            border-color: #059669 !important;
            background: #ecfdf5 !important;
            transform: scale(1.02);
        }

        .usage-chart-upload-area:hover {
            border-color: #059669 !important;
            background: #f0fdf4 !important;
            transform: scale(1.01);
        }

        .usage-chart-upload-area.drag-over {
            border-color: #059669 !important;
            background: #ecfdf5 !important;
            transform: scale(1.02);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: #059669;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .file-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .file-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            color: #333;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                padding: 1rem;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                gap: 0;
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links li {
                padding: 0.75rem 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .nav-links li:last-child {
                border-bottom: none;
            }

            .form-container {
                padding: 2rem 1.5rem;
                margin: 0 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .progress-bar::before {
                left: 12%;
                right: 12%;
            }
            
            /* SCE bill examples - stack on mobile */
            .sce-bill-examples {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 640px) {
            .cta-button.hide-mobile {
                display: none;
            }
        }

        /* Footer */
        footer {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: white;
            padding: 2.5rem 0;
            border-top: 1px solid rgba(16, 185, 129, 0.1);
        }

        .footer-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .footer-logo-icon {
            width: 32px;
            height: 32px;
            background: var(--brand-green);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .footer-logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .footer-logo-title {
            font-weight: 800;
            font-size: 1rem;
        }

        .footer-logo-subtitle {
            font-size: 0.875rem;
            color: #9CA3AF;
        }

        .footer-tagline {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            letter-spacing: -0.015em;
        }

        .footer-nav {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .footer-nav a {
            color: #9CA3AF;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-nav a:hover {
            color: white;
        }

        .footer-copyright {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            text-align: center;
        }

        .footer-copyright p {
            font-size: 0.875rem;
            color: #9CA3AF;
            margin: 0;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="container">
            <a href="index.html" class="logo">
                <img src="assets/images/microgrid_logo.png" alt="MicroGrid" height="50">
            </a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#join-movement">How It Works</a></li>
                <li><a href="index.html#nem">California (NEM 3.0)</a></li>
                <li><a href="index.html#impact">Results</a></li>
                <li><a href="index.html#compat">Compatibility</a></li>
                <li><a href="index.html#faq">FAQ</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="header-buttons">
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>
                <a href="#" onclick="checkInvitationCode(event)" class="cta-button-outline">Download App</a>
            </div>
        </nav>
    </header>

    <!-- Registration Form Section -->
    <section class="registration-form-section">
        <div class="container">
            <div class="form-container">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-step active">
                        <div class="progress-step-circle">1</div>
                        <div class="progress-step-label">System Setup</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">2</div>
                        <div class="progress-step-label">Contact Info</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">3</div>
                        <div class="progress-step-label">Inverter Connection</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2>Step 1 ‚Äî System Specifications & Usage Data</h2>
                    <p>Tell us about your battery system and electricity usage</p>
                </div>

                <form id="diyForm" action="#" method="POST">

                    <!-- Easy Start: Provide System Specs -->
                    <div style="background: #f9fafb; border: 2px solid #d1d5db; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üìä</span>
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.1rem; color: #374151; font-weight: 700; margin-bottom: 0.5rem;">Quick Start: Tell Us Your System Specs</h3>
                                <p style="color: #4b5563; font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem;">
                                    Just provide your system specifications below, and we'll calculate your estimated earnings. You can complete registration now and connect your system later.
                                </p>
                                
                                <p style="color: #374151; font-size: 0.875rem; margin-bottom: 1rem; padding: 0.75rem; background: #e0f2fe; border-radius: 8px; border-left: 3px solid #0ea5e9;">
                                    <strong>‚úÖ This is enough to get started!</strong> Simply enter your battery and solar capacity below. We'll send you personalized estimates within 24 hours.
                                </p>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="batteryCapacity">Battery Capacity (kWh) <span id="batteryCapacityRequired" style="display: none; color: #ef4444;">*</span></label>
                                        <input type="number" id="batteryCapacity" name="batteryCapacity" placeholder="e.g., 13.5" step="0.1" min="0">
                                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                                            Total usable battery storage capacity.
                                        </small>
                                    </div>
                                    <div class="form-group">
                                        <label for="pvWattage">Solar Panel Capacity (kW) <span id="pvWattageRequired" style="display: none; color: #ef4444;">*</span></label>
                                        <input type="number" id="pvWattage" name="pvWattage" placeholder="e.g., 8.5" step="0.1" min="0">
                                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                                            Total solar panel capacity in kilowatts.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Recent Electricity Bills or Enter Monthly Usage -->
                    <div style="background: #f9fafb; border: 2px solid #d1d5db; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üí°</span>
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.1rem; color: #374151; font-weight: 700; margin-bottom: 0.5rem;">Provide Your Energy Usage</h3>
                                <p style="color: #4b5563; font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem;">
                                    <strong>Help us estimate your savings faster!</strong> Either upload your recent utility bills or manually enter your annual or monthly daily average kWh usage.
                                </p>
                                
                                <!-- Toggle between Usage Input Methods -->
                                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1; min-width: 250px;">
                                        <input type="radio" name="usageInputMethod" id="dailyAverageRadio" value="dailyAverage" checked style="width: 18px; height: 18px; cursor: pointer; accent-color: #10B981;">
                                        <span style="font-weight: 600; color: #374151; font-size: 1rem;">üìä Annual Daily Average kWh</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1; min-width: 250px;">
                                        <input type="radio" name="usageInputMethod" id="manualRadio" value="manual" style="width: 18px; height: 18px; cursor: pointer; accent-color: #10B981;">
                                        <span style="font-weight: 600; color: #374151; font-size: 1rem;">‚å®Ô∏è Monthly Daily Average kWh</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1; min-width: 250px;">
                                        <input type="radio" name="usageInputMethod" id="uploadRadio" value="upload" style="width: 18px; height: 18px; cursor: pointer; accent-color: #10B981;">
                                        <span style="font-weight: 600; color: #374151; font-size: 1rem;">üìÑ Upload Bills</span>
                                    </label>
                                </div>
                                
                                <!-- Annual Daily Average Section -->
                                <div id="dailyAverageSection" class="usage-section">
                                    <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 1rem;">
                                        Provide your annual daily average electricity usage (kWh). This is the quickest option.
                                    </p>
                                    
                                    <!-- Daily Average Input -->
                                    <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                                        <div style="max-width: 400px;">
                                            <label for="dailyAverageKwh" style="display: block; font-weight: 600; color: #374151; font-size: 1rem; margin-bottom: 0.5rem;">
                                                Annual Daily Average (kWh)
                                            </label>
                                            <input type="number" id="dailyAverageKwh" name="dailyAverageKwh" placeholder="e.g., 24.10" step="0.01" min="0" style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                                            <small style="color: #6b7280; font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                                                Look for "This year:" in the daily average section of your utility bill
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Helper Note for Users Who Don't Know -->
                                    <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                                        <p style="color: #1e3a8a; font-size: 0.875rem; line-height: 1.6; margin: 0;">
                                            <strong>üí° Don't know where to find your annual daily average kWh?</strong> Select the <strong>"Monthly Daily Average kWh"</strong> option above ‚Äî it has a quick guide showing you exactly where to find it on your bill.
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- File Upload Section -->
                                <div id="uploadSection" class="usage-section" style="display: none;">
                                    <div class="file-upload-container">
                                        <div class="file-upload-area" id="fileUploadArea" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; background: #ffffff; cursor: pointer; transition: all 0.3s ease;">
                                            <div class="upload-icon" style="font-size: 3rem; margin-bottom: 0.5rem;">üìÑ</div>
                                            <p class="upload-text" style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Click to upload or drag and drop</p>
                                            <p class="upload-subtext" style="font-size: 0.875rem; color: #6b7280;">Upload up to 12 files (PDF or images) ‚Äî more recent bills are better</p>
                                            <input type="file" id="electricityBills" name="electricityBills" accept=".pdf,.jpg,.jpeg,.png" multiple style="display: none;">
                                        </div>
                                        <div id="fileList" class="file-list" style="margin-top: 1rem;"></div>
                                    </div>
                                    
                                    <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                                        <strong style="color: #059669;">Optional but helpful:</strong> Helps our AI estimate your savings faster.
                                    </small>
                                </div>
                                
                                <!-- Monthly Daily Average Section -->
                                <div id="manualSection" class="usage-section" style="display: none;">
                                    <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 1rem;">
                                        Enter your monthly daily average electricity usage (kWh) for each of the last 12 months. You can start from any month.
                                    </p>
                                    
                                    <!-- Important Note -->
                                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                        <p style="color: #92400e; font-size: 0.875rem; line-height: 1.6; margin: 0;">
                                            <strong>‚ö†Ô∏è Note on Accuracy:</strong> Manual entry from charts is for <strong>estimation purposes only</strong>. This approach is <strong>less accurate</strong> than uploading your actual utility bills, as reading precise numbers from charts can be challenging. For the most accurate savings estimates, we recommend uploading your complete utility bills using the "Upload Bills" tab above.
                                        </p>
                                    </div>
                                    
                                    <!-- SCE Bill Instructions -->
                                    <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                        <h4 style="color: #1e40af; font-size: 0.95rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span>üìä</span> How to Find Your Daily Average Usage (SCE Customers)
                                        </h4>
                                        <p style="color: #1e3a8a; font-size: 0.875rem; line-height: 1.6; margin-bottom: 1rem;">
                                            If you have <strong>Southern California Edison (SCE)</strong> as your utility provider, you can easily find your last 12 months of usage in the <strong>"Your past and current electricity usage"</strong> section of your bill.
                                        </p>
                                        
                                        <div class="sce-bill-examples" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                            <div>
                                                <p style="color: #1e3a8a; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">
                                                    Without Solar/Battery System
                                                </p>
                                                <img src="assets/images/sce_bill_no_system.png" alt="SCE bill without solar system" style="width: 100%; border-radius: 8px; border: 1px solid #cbd5e1; cursor: pointer;" onclick="window.open(this.src, '_blank')">
                                                <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; text-align: center;">
                                                    Look for "Total electricity you used this month"
                                                </p>
                                            </div>
                                            <div>
                                                <p style="color: #1e3a8a; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">
                                                    With Solar/Battery System
                                                </p>
                                                <img src="assets/images/sce_bill_with_system.png" alt="SCE bill with solar system" style="width: 100%; border-radius: 8px; border: 1px solid #cbd5e1; cursor: pointer;" onclick="window.open(this.src, '_blank')">
                                                <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; text-align: center;">
                                                    Look for the "Consumption" bars (black) in the chart
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <p style="color: #475569; font-size: 0.75rem; margin-top: 0.75rem; font-style: italic; text-align: center;">
                                            üí° Click on images to view full size
                                        </p>
                                    </div>
                                    
                                    <!-- Upload Usage Chart Screenshot -->
                                    <div style="background: #f0fdf4; border: 2px solid #10B981; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                        <h4 style="color: #059669; font-size: 0.95rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span>üì∏</span> Easier Option: Upload a Screenshot
                                        </h4>
                                        <p style="color: #047857; font-size: 0.875rem; line-height: 1.6; margin-bottom: 1rem;">
                                            <strong>Don't worry about reading the exact numbers from the chart!</strong> You can take a screenshot of the "Your past and current electricity usage" section from your bill, and we'll extract the numbers for you automatically.
                                        </p>
                                        
                                        <div class="usage-chart-upload-area" id="usageChartUploadArea" style="border: 2px dashed #10B981; border-radius: 8px; padding: 1.5rem; text-align: center; background: #ffffff; cursor: pointer; transition: all 0.3s ease;">
                                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìä</div>
                                            <p style="font-weight: 600; color: #059669; margin-bottom: 0.25rem;">Click to upload usage chart screenshot</p>
                                            <p style="font-size: 0.875rem; color: #6b7280;">PNG, JPG, or PDF accepted</p>
                                            <input type="file" id="usageChartScreenshot" name="usageChartScreenshot" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                                        </div>
                                        
                                        <div id="usageChartFileDisplay" style="margin-top: 1rem;"></div>
                                        
                                        <small style="color: #047857; font-size: 0.875rem; margin-top: 0.75rem; display: block;">
                                            <strong style="color: #059669;">üí° Recommended:</strong> This is more accurate than manual entry and faster than typing! Our AI will extract the numbers automatically.
                                        </small>
                                    </div>
                                    
                                    <div style="text-align: center; margin-bottom: 1rem;">
                                        <p style="color: #6b7280; font-size: 0.875rem; font-weight: 600;">- OR -</p>
                                        <p style="color: #6b7280; font-size: 0.875rem;">Manually enter your monthly usage below:</p>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthJanuary" style="font-size: 0.875rem;">January</label>
                                            <input type="number" id="monthJanuary" name="monthJanuary" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthFebruary" style="font-size: 0.875rem;">February</label>
                                            <input type="number" id="monthFebruary" name="monthFebruary" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthMarch" style="font-size: 0.875rem;">March</label>
                                            <input type="number" id="monthMarch" name="monthMarch" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthApril" style="font-size: 0.875rem;">April</label>
                                            <input type="number" id="monthApril" name="monthApril" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthMay" style="font-size: 0.875rem;">May</label>
                                            <input type="number" id="monthMay" name="monthMay" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthJune" style="font-size: 0.875rem;">June</label>
                                            <input type="number" id="monthJune" name="monthJune" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthJuly" style="font-size: 0.875rem;">July</label>
                                            <input type="number" id="monthJuly" name="monthJuly" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthAugust" style="font-size: 0.875rem;">August</label>
                                            <input type="number" id="monthAugust" name="monthAugust" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthSeptember" style="font-size: 0.875rem;">September</label>
                                            <input type="number" id="monthSeptember" name="monthSeptember" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthOctober" style="font-size: 0.875rem;">October</label>
                                            <input type="number" id="monthOctober" name="monthOctober" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthNovember" style="font-size: 0.875rem;">November</label>
                                            <input type="number" id="monthNovember" name="monthNovember" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label for="monthDecember" style="font-size: 0.875rem;">December</label>
                                            <input type="number" id="monthDecember" name="monthDecember" placeholder="kWh" step="0.1" min="0" style="padding: 0.5rem; font-size: 0.9rem;">
                                        </div>
                                    </div>
                                    
                                    <small style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem; display: block;">
                                        <strong style="color: #059669;">üí° Tip:</strong> You can find your kWh usage on your utility bills. Don't worry if you don't have all 12 months‚Äîfill in what you have!
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p style="text-align: center; margin: 1.5rem 0 0.75rem 0; padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border-radius: 12px; border: 2px solid #10B981;">
                        <span style="display: block; color: #059669; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">üéÅ UNLOCK YOUR EARNING POTENTIAL</span>
                        <span style="display: block; color: #047857; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Typical range for similar systems: $600‚Äì$2,400/year</span>
                        <span style="display: block; color: #6b7280; font-size: 0.85rem;">Get your quick estimate ‚Üì</span>
                    </p>

                    <button type="submit" class="submit-btn" id="submitBtn">Calculate Quick Estimate & Continue</button>
                    
                    <p style="text-align: center; margin-top: 1rem; color: #6b7280; font-size: 0.95rem;" id="submitHelpText">üí° You'll receive your results within 24 hours.</p>

                    <div style="text-align: center; margin-top: 1.25rem;">
                        <a href="mailto:support@microvpp.com" style="display: inline-block; padding: 0.75rem 1.5rem; background: #f0fdf4; color: #059669; text-decoration: none; font-weight: 600; border-radius: 8px; border: 2px solid #10B981; transition: all 0.3s ease;">
                            üí¨ Need help connecting? Contact Support
                        </a>
                    </div>

                    <small style="display: block; text-align: center; margin-top: 1.5rem; color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                        By continuing you agree to our <a href="privacy.html" style="color: #059669;">Privacy Policy</a>.  
                        We only read system data to generate savings; we never sell personal data.
                    </small>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="footer-logo-icon"></span>
                    <div class="footer-logo-text">
                        <div class="footer-logo-title">MicroVPP‚Ñ¢</div>
                        <div class="footer-logo-subtitle">by MicroGrid</div>
                    </div>
                </div>
                <div class="footer-tagline">Smarter homes. Stronger grids.</div>
                <nav class="footer-nav">
                    <a href="index.html">Home</a>
                    <a href="about.html">About</a>
                    <a href="privacy.html">Privacy</a>
                    <a href="terms.html">Terms</a>
                    <a href="mailto:info@microvpp.com">Contact</a>
                </nav>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2025 MicroGrid LLC. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // MOBILE MENU
        // ============================================
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');
        
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                navLinks.classList.toggle('active');
                this.textContent = navLinks.classList.contains('active') ? '‚úï' : '‚ò∞';
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('nav')) {
                    navLinks.classList.remove('active');
                    mobileMenuBtn.textContent = '‚ò∞';
                }
            });

            // Close menu when clicking a link
            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', function() {
                    navLinks.classList.remove('active');
                    mobileMenuBtn.textContent = '‚ò∞';
                });
            });
        }

        // ============================================
        // USAGE INPUT TAB SWITCHING
        // ============================================
        const uploadRadio = document.getElementById('uploadRadio');
        const manualRadio = document.getElementById('manualRadio');
        const dailyAverageRadio = document.getElementById('dailyAverageRadio');
        const uploadSection = document.getElementById('uploadSection');
        const manualSection = document.getElementById('manualSection');
        const dailyAverageSection = document.getElementById('dailyAverageSection');

        if (uploadRadio && manualRadio && dailyAverageRadio) {
            uploadRadio.addEventListener('change', function() {
                if (this.checked) {
                    uploadSection.style.display = 'block';
                    manualSection.style.display = 'none';
                    dailyAverageSection.style.display = 'none';
                }
            });

            manualRadio.addEventListener('change', function() {
                if (this.checked) {
                    manualSection.style.display = 'block';
                    uploadSection.style.display = 'none';
                    dailyAverageSection.style.display = 'none';
                }
            });

            dailyAverageRadio.addEventListener('change', function() {
                if (this.checked) {
                    dailyAverageSection.style.display = 'block';
                    uploadSection.style.display = 'none';
                    manualSection.style.display = 'none';
                }
            });
        }

        // ============================================
        // FILE UPLOAD HANDLING
        // ============================================
        let uploadedFiles = [];
        let usageChartFile = null;
        const MAX_FILES = 12;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB per file

        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('electricityBills');
        const fileList = document.getElementById('fileList');
        
        // Usage chart screenshot upload
        const usageChartUploadArea = document.getElementById('usageChartUploadArea');
        const usageChartInput = document.getElementById('usageChartScreenshot');
        const usageChartFileDisplay = document.getElementById('usageChartFileDisplay');

        // Click to upload
        if (fileUploadArea) {
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });
        }

        // Handle file selection
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // Drag and drop handlers
        if (fileUploadArea) {
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('drag-over');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('drag-over');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            const newFiles = Array.from(files);
            
            if (uploadedFiles.length + newFiles.length > MAX_FILES) {
                alert(`You can only upload up to ${MAX_FILES} files. You currently have ${uploadedFiles.length} file(s).`);
                return;
            }

            let hasErrors = false;
            newFiles.forEach(file => {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    hasErrors = true;
                    return;
                }

                const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    alert(`File "${file.name}" has an invalid type. Please upload PDF or image files.`);
                    hasErrors = true;
                    return;
                }

                uploadedFiles.push(file);
            });

            displayFiles();
            fileInput.value = '';
        }

        function displayFiles() {
            if (!fileList) return;
            
            fileList.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = getFileIcon(file.type);
                const fileSize = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <div class="file-details">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                    </div>
                    <button type="button" class="file-remove" onclick="removeFile(${index})">√ó</button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFiles();
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') return 'üìÑ';
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            return 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ============================================
        // USAGE CHART SCREENSHOT UPLOAD HANDLING
        // ============================================
        
        // Click to upload usage chart screenshot
        if (usageChartUploadArea) {
            usageChartUploadArea.addEventListener('click', () => {
                usageChartInput.click();
            });
        }

        // Handle usage chart screenshot selection
        if (usageChartInput) {
            usageChartInput.addEventListener('change', (e) => {
                handleUsageChartFile(e.target.files[0]);
            });
        }

        // Drag and drop handlers for usage chart
        if (usageChartUploadArea) {
            usageChartUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                usageChartUploadArea.classList.add('drag-over');
            });

            usageChartUploadArea.addEventListener('dragleave', () => {
                usageChartUploadArea.classList.remove('drag-over');
            });

            usageChartUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                usageChartUploadArea.classList.remove('drag-over');
                handleUsageChartFile(e.dataTransfer.files[0]);
            });
        }

        function handleUsageChartFile(file) {
            if (!file) return;
            
            if (file.size > MAX_FILE_SIZE) {
                alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                return;
            }

            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                alert(`File "${file.name}" has an invalid type. Please upload PDF or image files.`);
                return;
            }

            usageChartFile = file;
            displayUsageChartFile();
            usageChartInput.value = '';
        }

        function displayUsageChartFile() {
            if (!usageChartFileDisplay || !usageChartFile) return;
            
            const fileIcon = getFileIcon(usageChartFile.type);
            const fileSize = formatFileSize(usageChartFile.size);
            
            usageChartFileDisplay.innerHTML = `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <div class="file-details">
                            <span class="file-name">${usageChartFile.name}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                    </div>
                    <button type="button" class="file-remove" onclick="removeUsageChartFile()">√ó</button>
                </div>
            `;
        }

        function removeUsageChartFile() {
            usageChartFile = null;
            if (usageChartFileDisplay) {
                usageChartFileDisplay.innerHTML = '';
            }
        }

        // ============================================
        // LOAD STEP 1 DATA FROM SESSION STORAGE & PRE-FILL FORM
        // ============================================
        
        let step1Data = {}; // System setup data (this is now Step 1)
        let step2Data = {}; // Contact info data (this is now Step 2)
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load step 1 (system setup) data if returning from step 2
            const storedStep1Data = sessionStorage.getItem('registrationStep1');
            if (storedStep1Data) {
                try {
                    step1Data = JSON.parse(storedStep1Data);
                    console.log('Loaded Step 1 (System Setup) data:', step1Data);
                
                } catch (error) {
                    console.error('Error loading Step 1 data:', error);
                }
            }
            
            // Load step 2 (contact info) data if available
            const storedStep2Data = sessionStorage.getItem('registrationStep2');
            if (storedStep2Data) {
                try {
                    step2Data = JSON.parse(storedStep2Data);
                    console.log('Loaded Step 2 (Contact Info) data:', step2Data);
                } catch (error) {
                    console.error('Error loading Step 2 data:', error);
                }
            }
            
            // Pre-fill form if returning from Step 2
            if (step1Data) {
                try {
                    console.log('Pre-filling Step 1 form with saved data:', step1Data);
                    
                    // Pre-fill system specs fields (only fields in step 1 now)
                    if (step1Data.batteryCapacity) document.getElementById('batteryCapacity').value = step1Data.batteryCapacity;
                    if (step1Data.pvWattage) document.getElementById('pvWattage').value = step1Data.pvWattage;
                    
                    // Pre-fill monthly kWh data if available
                    if (step1Data.monthlyKwh) {
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                        let hasMonthlyData = false;
                        for (const monthName of monthNames) {
                            const monthValue = step1Data.monthlyKwh[`month${monthName}`];
                            if (monthValue) {
                                const inputElement = document.getElementById(`month${monthName}`);
                                if (inputElement) {
                                    inputElement.value = monthValue;
                                    hasMonthlyData = true;
                                }
                            }
                        }
                        // If monthly data was provided, switch to manual tab
                        if (hasMonthlyData && manualRadio) {
                            manualRadio.checked = true;
                            manualRadio.dispatchEvent(new Event('change'));
                        }
                    }

                    // Pre-fill daily average kWh if available
                    if (step1Data.dailyAverageKwh) {
                        document.getElementById('dailyAverageKwh').value = step1Data.dailyAverageKwh;
                        // If daily average was provided, switch to daily average tab
                        if (dailyAverageRadio) {
                            dailyAverageRadio.checked = true;
                            dailyAverageRadio.dispatchEvent(new Event('change'));
                        }
                    }
                    
                    // Update field requirements after pre-filling
                    updateFieldRequirements();
                    
                    // Show a message if files were already uploaded
                    const filesAlreadyUploaded = sessionStorage.getItem('filesUploadedInStep1') === 'true';
                    const uploadedFileCount = sessionStorage.getItem('uploadedFileCount');
                    if (filesAlreadyUploaded && uploadedFileCount) {
                        // Display a message in the file list area
                        if (fileList) {
                            fileList.innerHTML = `
                                <div style="padding: 1rem; background: #ecfdf5; border: 2px solid #10B981; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úì</div>
                                    <p style="font-weight: 600; color: #059669; margin-bottom: 0.25rem;">
                                        Files Already Uploaded
                                    </p>
                                    <p style="color: #047857; font-size: 0.9rem;">
                                        ${uploadedFileCount} file(s) from your previous session are saved.
                                    </p>
                                    <p style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem;">
                                        You can proceed to Step 2 or upload additional files if needed.
                                    </p>
                                </div>
                            `;
                        }
                    }
                    
                    // Show a message if usage chart was already uploaded
                    const usageChartAlreadyUploaded = sessionStorage.getItem('usageChartUploadedInStep1') === 'true';
                    if (usageChartAlreadyUploaded && usageChartFileDisplay) {
                        usageChartFileDisplay.innerHTML = `
                            <div style="padding: 1rem; background: #ecfdf5; border: 2px solid #10B981; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚úì</div>
                                <p style="font-weight: 600; color: #059669; font-size: 0.9rem;">
                                    Usage chart screenshot already uploaded
                                </p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error pre-filling Step 1 form:', error);
                }
            }
        });

        // ============================================
        // API CONFIGURATION
        // ============================================
        
        const API_BASE_URL = 'https://3dbhitxwoc.execute-api.us-east-2.amazonaws.com/dev';
        const REGISTER_ENDPOINT = '/auth/signup';
        const UPDATE_PROFILE_ENDPOINT = '/auth/update-profile';
        const UPLOAD_BILLS_ENDPOINT = '/admin/upload-utility-bills';

        // Dynamic validation based on system specs
        const batteryCapacityInput = document.getElementById('batteryCapacity');
        const pvWattageInput = document.getElementById('pvWattage');
        const batteryCapacityRequired = document.getElementById('batteryCapacityRequired');
        const pvWattageRequired = document.getElementById('pvWattageRequired');

        // Function to update field requirements based on what's provided
        function updateFieldRequirements() {
            const hasAlternativeSpecs = batteryCapacityInput.value.trim() !== '' && pvWattageInput.value.trim() !== '';
            const submitBtn = document.getElementById('submitBtn');
            const submitHelpText = document.getElementById('submitHelpText');
            
            if (hasAlternativeSpecs) {
                // Battery and solar specs are provided
                batteryCapacityRequired.style.display = 'inline';
                pvWattageRequired.style.display = 'inline';
                batteryCapacityInput.setAttribute('required', 'required');
                pvWattageInput.setAttribute('required', 'required');
                
                // Update button text for specs-only (will go to step 2)
                submitBtn.textContent = 'Continue to Step 2 ‚Üí';
                submitHelpText.textContent = 'üí° Next: Provide contact information and system connection (optional).';
            } else {
                // Battery and solar specs are required
                batteryCapacityRequired.style.display = 'inline';
                pvWattageRequired.style.display = 'inline';
                batteryCapacityInput.setAttribute('required', 'required');
                pvWattageInput.setAttribute('required', 'required');
                
                // Default button text
                submitBtn.textContent = 'Continue';
                submitHelpText.textContent = 'üí° Next: Provide contact information and system connection (optional).';
            }
        }

        // Listen for changes in alternative spec fields
        batteryCapacityInput.addEventListener('input', updateFieldRequirements);
        pvWattageInput.addEventListener('input', updateFieldRequirements);
        
        // Initialize on page load
        updateFieldRequirements();

        // Generate a unique inverter ID
        function generateInverterId() {
            return 'INV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Generate a random UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Format phone number to E.164 format
        function formatPhoneToE164(phone) {
            if (!phone) return null;
            
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 10) {
                return '+1' + digits;
            } else if (digits.length === 11 && digits.startsWith('1')) {
                return '+' + digits;
            } else if (phone.startsWith('+')) {
                return phone;
            } else if (digits.length === 11) {
                return '+' + digits;
            }
            
            return '+1' + digits;
        }

        // Convert data URL files back to File objects for upload
        async function dataURLtoFile(dataurl, filename) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        // Map form data to API payload
        async function mapFormToPayload(formData) {
            const manufacturer = formData.get('inverterManufacturer');
            const otherManufacturer = formData.get('otherManufacturer');
            const inverterId = generateInverterId();
            const username = formData.get('username');
            const password = formData.get('password');
            const hasCredentials = username && username.trim() !== '' && password && password.trim() !== '';
            const isSimulationMode = !hasCredentials;
            
            // Determine the inverter type
            const inverterManufacturer = manufacturer === 'Other' && otherManufacturer 
                ? otherManufacturer 
                : manufacturer;

            // Collect monthly kWh data if provided
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthlyKwh = [];
            for (const monthName of monthNames) {
                const monthValue = formData.get(`month${monthName}`);
                if (monthValue && monthValue.trim() !== '') {
                    monthlyKwh.push(parseFloat(monthValue));
                } else {
                    monthlyKwh.push(null);
                }
            }
            
            // Check if any monthly data was provided
            const hasMonthlyData = monthlyKwh.some(val => val !== null);
            
            // Get daily average if provided
            const dailyAverageKwh = formData.get('dailyAverageKwh');
            const hasDailyAverage = dailyAverageKwh && dailyAverageKwh.trim() !== '';

            // Build the info object with all additional user and system information
            // Note: step2Data contains contact info (now Step 2), step1Data contains system setup (now Step 1)
            const info = {
                contact: {
                    name: step2Data.fullName || null,
                    email: step2Data.email || null,
                    phone: step2Data.phone || null
                },
                location: {
                    address: step2Data.address || null,
                    city: step2Data.city || null,
                    state: step2Data.state || null
                },
                system: {
                    battery_capacity_kwh: formData.get('batteryCapacity') ? parseFloat(formData.get('batteryCapacity')) : null,
                    pv_wattage_kw: formData.get('pvWattage') ? parseFloat(formData.get('pvWattage')) : null,
                    installation_date: formData.get('installationDate') || null,
                    utility_company: step2Data.utilityCompany || null,
                    serial_number: formData.get('serialNumber') || null
                },
                registration: {
                    mode: isSimulationMode ? 'simulation' : 'direct_connection',
                    vpp_participation: formData.get('vppParticipation') === 'on',
                    marketing_consent: formData.get('marketing') === 'on',
                    terms_accepted: step2Data.termsAccepted || false,
                    registration_date: new Date().toISOString(),
                    registration_source: 'diy-web-form-step1'
                },
                electricity_bills: {
                    uploaded_count: uploadedFiles.length,
                    files: uploadedFiles.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    })),
                    monthly_kwh_provided: hasMonthlyData,
                    monthly_kwh: hasMonthlyData ? monthlyKwh : null,
                    daily_average_kwh_provided: hasDailyAverage,
                    daily_average_kwh: hasDailyAverage ? parseFloat(dailyAverageKwh) : null,
                    usage_chart_screenshot: usageChartFile ? {
                        name: usageChartFile.name,
                        size: usageChartFile.size,
                        type: usageChartFile.type
                    } : null
                },
                notes: formData.get('additionalNotes') || null
            };

            // Build the API payload
            const payload = {
                entity_type: "inverter",
                username: step2Data.fullName || null,
                email: step2Data.email || null,
                phone_number: formatPhoneToE164(step2Data.phone),
                full_address: step2Data.address || null,
                city: step2Data.city || null,
                state: step2Data.state || null,
                zip: step2Data.zip || null,
                country: "US",
                latitude: null,
                longitude: null,
                timezone: null,
                locale: "en-US",
                inverter_inverter_id: inverterId,
                inverter_inverter_type: "hybrid_inverter",
                inverter_manufacturer: inverterManufacturer,
                inverter_serial_number: formData.get('serialNumber'),
                inverter_monitoring_id: null,
                inverter_monitoring_token: null,
                inverter_monitoring_url: null,
                inverter_api_key: formData.get('username'),
                inverter_api_secret: formData.get('password'),
                info: JSON.stringify(info),
                site_id: null,
                site_type: "residential",
                installation_date: formData.get('installationDate') || null,
            };

            return payload;
        }

        // Get pre-signed URLs from the API
        async function getPresignedUrls(userId, files) {
            const filesMetadata = files.map(file => ({
                filename: file.name,
                content_type: file.type || 'application/octet-stream'
            }));
            
            console.log(`Requesting pre-signed URLs for ${files.length} file(s)...`);
            
            const response = await fetch(API_BASE_URL + UPLOAD_BILLS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    account_id: userId,
                    files: filesMetadata
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.detail || `Failed to get upload URLs: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // Upload a single file to S3 using pre-signed URL
        async function uploadFileToS3(file, presignedInfo, fileNum, totalFiles) {
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            console.log(`Uploading file ${fileNum}/${totalFiles}: ${file.name} (${fileSizeMB}MB) to S3...`);

            // Build form data with all required fields from pre-signed URL
            const formData = new FormData();

            // Add all the pre-signed fields first (order matters for S3)
            for (const [key, value] of Object.entries(presignedInfo.presigned_fields)) {
                formData.append(key, value);
            }

            // Add the file last (required by S3)
            formData.append('file', file);

            // Create abort controller with 10-minute timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 10 * 60 * 1000); // 10 minutes

            try {
                const response = await fetch(presignedInfo.presigned_url, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                // S3 returns 204 on success for pre-signed POST
                if (!response.ok && response.status !== 204) {
                    const errorText = await response.text().catch(() => '');
                    throw new Error(`S3 upload failed: ${response.status} - ${errorText}`);
                }

                console.log(`File ${fileNum} uploaded successfully to: ${presignedInfo.s3_key}`);
                return { success: true, s3_key: presignedInfo.s3_key };
            } catch (error) {
                clearTimeout(timeoutId);

                if (error.name === 'AbortError') {
                    throw new Error(`File ${fileNum} (${file.name}) upload timed out after 10 minutes`);
                }
                console.warn(`S3 upload failed for file ${fileNum}: ${error.message}`);
                throw error;
            }
        }
        
        // Legacy function for backwards compatibility
        async function uploadSingleFile(userId, file, fileNum, totalFiles) {
            // Get pre-signed URL for this single file
            const presignedResponse = await getPresignedUrls(userId, [file]);

            if (presignedResponse.failed_files?.length > 0) {
                throw new Error(presignedResponse.failed_files[0].error || 'Failed to get upload URL');
            }

            if (!presignedResponse.presigned_urls?.length) {
                throw new Error('No pre-signed URL returned from server');
            }

            return await uploadFileToS3(file, presignedResponse.presigned_urls[0], fileNum, totalFiles);
        }

        // Upload utility bills using S3 pre-signed URLs
        // Zips multiple utility bills, uploads screenshots individually
        async function uploadUtilityBills(userId, files, onProgress) {
            if (!files || files.length === 0) {
                console.log('No utility bills to upload');
                return { success: true, message: 'No files to upload', uploadedFiles: [], failedFiles: [], errors: [] };
            }

            const uploadedFiles = [];
            const failedFiles = [];
            const errors = [];

            // Check if we can use ZIP compression for utility bills (reduces number of uploads)
            if (files.length > 1 && window.JSZip) {
                try {
                    console.log('Preparing to upload files as single ZIP...');

                    const zip = new JSZip();
                    Array.from(files).forEach(file => {
                        zip.file(file.name, file);
                    });

                    const zipBlob = await zip.generateAsync({
                        type: "blob",
                        compression: "DEFLATE",
                        compressionOptions: { level: 6 }
                    });

                    console.log(`ZIP created: ${(zipBlob.size/1024/1024).toFixed(2)}MB`);

                    if (zipBlob.size < 50 * 1024 * 1024) { // 50MB limit (S3 pre-signed URL limit)
                        const zipFile = new File([zipBlob], `utility_bills_${Date.now()}.zip`, { type: "application/zip" });

                        if (onProgress) onProgress(0, 1, 0, 1);

                        // Get pre-signed URL and upload the ZIP
                        const presignedResponse = await getPresignedUrls(userId, [zipFile]);
                        
                        if (presignedResponse.presigned_urls && presignedResponse.presigned_urls.length > 0) {
                            await uploadFileToS3(zipFile, presignedResponse.presigned_urls[0], 1, 1);
                            
                            // Mark all original files as uploaded
                            uploadedFiles.push(...files);
                            console.log(`ZIP upload successful`);

                            if (onProgress) onProgress(1, 1, files.length, files.length);

                            return {
                                success: true,
                                partial: false,
                                uploadedFiles,
                                failedFiles: [],
                                errors: [],
                                message: `All files uploaded as ZIP`
                            };
                        } else {
                            console.warn('Failed to get pre-signed URL for ZIP');
                        }
                    } else {
                        console.warn(`ZIP is too large (>50MB), will upload files individually`);
                    }
                } catch (zipError) {
                    console.warn(`ZIP upload failed:`, zipError.message);
                    // Fallthrough to individual upload logic below
                }
            }

            // Upload files individually using pre-signed URLs
            console.log(`Uploading ${files.length} file(s) individually using pre-signed URLs...`);

            try {
                // Get all pre-signed URLs at once (more efficient)
                const presignedResponse = await getPresignedUrls(userId, files);

                // Handle files that failed to get pre-signed URLs
                if (presignedResponse.failed_files?.length > 0) {
                    for (const failed of presignedResponse.failed_files) {
                        const file = files.find(f => f.name === failed.filename);
                        if (file) {
                            failedFiles.push(file);
                            errors.push(`${failed.filename}: ${failed.error}`);
                        }
                    }
                }

                // Upload each file to S3
                const presignedUrls = presignedResponse.presigned_urls || [];
                for (let i = 0; i < presignedUrls.length; i++) {
                    const presignedInfo = presignedUrls[i];
                    const file = files.find(f => f.name === presignedInfo.filename);

                    if (!file) continue;

                    if (onProgress) onProgress(i, presignedUrls.length, uploadedFiles.length, files.length);

                    try {
                        await uploadFileToS3(file, presignedInfo, i + 1, presignedUrls.length);
                        uploadedFiles.push(file);
                    } catch (error) {
                        failedFiles.push(file);
                        errors.push(`${file.name}: ${error.message}`);
                    }
                }

                const summary = `${uploadedFiles.length}/${files.length} files uploaded successfully`;
                console.log(summary);

                if (failedFiles.length > 0) {
                    console.warn('Some files failed:', errors);
                }

                return {
                    success: failedFiles.length === 0,
                    uploadedFiles,
                    failedFiles,
                    errors,
                    message: summary
                };
            } catch (error) {
                console.error('Utility bill upload error:', error);
                return {
                    success: false,
                    uploadedFiles,
                    failedFiles,
                    errors: [...errors, error.message],
                    message: error.message
                };
            }
        }

        // Update profile with Step 2 data
        async function updateProfile(formData) {
            try {
                const userId = sessionStorage.getItem('registrationUserId');
                if (!userId) {
                    throw new Error('No user_id found. Please complete Step 1 first.');
                }
                
                const manufacturer = formData.get('inverterManufacturer');
                const otherManufacturer = formData.get('otherManufacturer');
                
                // Determine the inverter type
                const inverterManufacturer = manufacturer === 'Other' && otherManufacturer 
                    ? otherManufacturer 
                    : manufacturer;
                
                // Collect monthly kWh data if provided
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const monthlyKwh = [];
                for (const monthName of monthNames) {
                    const monthValue = formData.get(`month${monthName}`);
                    if (monthValue && monthValue.trim() !== '') {
                        monthlyKwh.push(parseFloat(monthValue));
                    } else {
                        monthlyKwh.push(null);
                    }
                }
                
                // Check if any monthly data was provided
                const hasMonthlyData = monthlyKwh.some(val => val !== null);
                
                // Get daily average if provided
                const dailyAverageKwh = formData.get('dailyAverageKwh');
                const hasDailyAverage = dailyAverageKwh && dailyAverageKwh.trim() !== '';
                
                // Build the info object with all data from step 1 (system setup) and step 2 (contact info)
                const info = {
                    contact: {
                        name: step2Data.fullName || null,
                        email: step2Data.email || null,
                        phone: step2Data.phone || null
                    },
                    location: {
                        address: step2Data.address || null,
                        city: step2Data.city || null,
                        state: step2Data.state || null
                    },
                    system: {
                        battery_capacity_kwh: formData.get('batteryCapacity') ? parseFloat(formData.get('batteryCapacity')) : null,
                        pv_wattage_kw: formData.get('pvWattage') ? parseFloat(formData.get('pvWattage')) : null,
                        installation_date: formData.get('installationDate') || null,
                        utility_company: step2Data.utilityCompany || null,
                        serial_number: formData.get('serialNumber') || null
                    },
                    registration: {
                        mode: 'partial',
                        status: 'step1_completed',
                        vpp_participation: formData.get('vppParticipation') === 'on',
                        marketing_consent: formData.get('marketing') === 'on',
                        terms_accepted: step2Data.termsAccepted || false,
                        registration_date: new Date().toISOString(),
                        registration_source: 'diy-web-form-step1'
                    },
                    electricity_bills: {
                        uploaded_count: uploadedFiles.length,
                        files: uploadedFiles.map(file => ({
                            name: file.name,
                            size: file.size,
                            type: file.type
                        })),
                        monthly_kwh_provided: hasMonthlyData,
                        monthly_kwh: hasMonthlyData ? monthlyKwh : null,
                        daily_average_kwh_provided: hasDailyAverage,
                        daily_average_kwh: hasDailyAverage ? parseFloat(dailyAverageKwh) : null,
                        usage_chart_screenshot: usageChartFile ? {
                            name: usageChartFile.name,
                            size: usageChartFile.size,
                            type: usageChartFile.type
                        } : null
                    },
                    notes: formData.get('additionalNotes') || null
                };
                
                // Build the API payload for profile update
                const payload = {
                    account_id: userId,
                    entity_type: "inverter",
                    username: step2Data.fullName || null,
                    email: step2Data.email || null,
                    phone_number: formatPhoneToE164(step2Data.phone),
                    full_address: step2Data.address || null,
                    city: step2Data.city || null,
                    state: step2Data.state || null,
                    zip: step2Data.zip || null,
                    country: "US",
                    latitude: null,
                    longitude: null,
                    timezone: null,
                    locale: "en-US",
                    inverter_inverter_id: null, // Don't change inverter_id if already set
                    inverter_inverter_type: "hybrid_inverter",
                    inverter_manufacturer: inverterManufacturer,
                    inverter_serial_number: formData.get('serialNumber'),
                    inverter_monitoring_id: null,
                    inverter_monitoring_token: null,
                    inverter_monitoring_url: null,
                    inverter_api_key: formData.get('username'),
                    inverter_api_secret: formData.get('password'),
                    info: JSON.stringify(info),
                    site_id: null,
                    site_type: "residential",
                    installation_date: formData.get('installationDate') || null,
                };
                
                console.log('Updating profile (Step 2) for user_id:', userId, payload);
                
                const response = await fetch(API_BASE_URL + UPDATE_PROFILE_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(
                        errorData?.detail || 
                        `Profile update failed with status: ${response.status}`
                    );
                }
                
                const result = await response.json();
                console.log('Profile updated successfully (Step 2):', result);
                
                return { success: true, result };
            } catch (error) {
                console.error('Error updating profile (Step 2):', error);
                return { success: false, error: error.message };
            }
        }
        
        // Submit form to API
        async function submitRegistration(payload) {
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Connecting Your System...';
                submitBtn.style.opacity = '0.7';

                // Check if user_id exists in session storage
                const userId = sessionStorage.getItem('registrationUserId');
                let endpoint = REGISTER_ENDPOINT;
                let result;
                
                if (userId) {
                    // User already registered, use update-profile endpoint
                    console.log('User ID found, using update-profile endpoint:', userId);
                    endpoint = UPDATE_PROFILE_ENDPOINT;
                    
                    // Add account_id to payload for update
                    const updatePayload = {
                        ...payload,
                        account_id: userId
                    };
                    
                    const response = await fetch(API_BASE_URL + endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(updatePayload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(
                            errorData?.detail || 
                            `Profile update failed with status: ${response.status}`
                        );
                    }

                    result = await response.json();
                    console.log('Profile update successful:', result);
                    
                    // Use existing user_id for result
                    result.user_id = userId;
                } else {
                    // New user, use signup endpoint
                    console.log('No user ID found, using signup endpoint');
                    
                    const response = await fetch(API_BASE_URL + endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(
                            errorData?.detail || 
                            `Registration failed with status: ${response.status}`
                        );
                    }

                    result = await response.json();
                    console.log('Registration successful:', result);
                }
                
                // Parse info to access registration mode
                const infoObj = JSON.parse(payload.info);

                // Upload utility bills if any files were selected and not already uploaded in Step 1
                let totalFilesUploaded = window.alreadyUploadedCount || 0;
                
                // Combine regular utility bills and usage chart screenshot
                const allFilesToUpload = [...uploadedFiles];
                if (usageChartFile && !window.filesAlreadyUploaded) {
                    allFilesToUpload.push(usageChartFile);
                }
                
                if (allFilesToUpload.length > 0 && result.user_id && !window.filesAlreadyUploaded) {
                    const totalFileSize = allFilesToUpload.reduce((sum, f) => sum + (f.size || 0), 0);
                    console.log(`Uploading ${allFilesToUpload.length} file(s) (${(totalFileSize / 1024 / 1024).toFixed(1)}MB) using S3 pre-signed URLs`);
                    
                    // Progress callback
                    const onProgress = (batchIndex, totalBatches, filesUploaded, totalFiles) => {
                        const percent = Math.round((filesUploaded / totalFiles) * 100);
                        submitBtn.textContent = `Uploading utility bills (${percent}%)...`;
                    };
                    
                    const uploadResult = await uploadUtilityBills(result.user_id, allFilesToUpload, onProgress);
                    
                    if (!uploadResult.success) {
                        console.warn('Some utility bills failed to upload:', uploadResult.errors);
                        totalFilesUploaded += uploadResult.uploadedFiles.length;
                    } else {
                        totalFilesUploaded += uploadResult.uploadedFiles.length;
                    }
                } else if (allFilesToUpload.length > 0 && window.filesAlreadyUploaded) {
                    totalFilesUploaded = allFilesToUpload.length;
                    console.log('Utility bills already uploaded in Step 1, skipping upload');
                }

                // Build success message based on mode
                const isSimulationMode = infoObj.registration.mode === 'simulation';
                const hasMonthlyKwhData = infoObj.electricity_bills.monthly_kwh_provided || false;
                const hasDailyAverageData = infoObj.electricity_bills.daily_average_kwh_provided || false;
                let successMessage = '';
                
                if (isSimulationMode) {
                    successMessage = 'üéâ Success! We\'re preparing your savings estimate!\n\n';
                    
                    if (totalFilesUploaded > 0 && hasMonthlyKwhData) {
                        successMessage += `We've received ${totalFilesUploaded} electricity bill file(s) and your monthly kWh usage data for analysis.\n\n`;
                    } else if (totalFilesUploaded > 0 && hasDailyAverageData) {
                        successMessage += `We've received ${totalFilesUploaded} electricity bill file(s) and your daily average kWh for analysis.\n\n`;
                    } else if (totalFilesUploaded > 0) {
                        successMessage += `We've received ${totalFilesUploaded} electricity bill file(s) for analysis.\n\n`;
                    } else if (hasMonthlyKwhData) {
                        successMessage += `We've received your monthly kWh usage data for analysis.\n\n`;
                    } else if (hasDailyAverageData) {
                        successMessage += `We've received your daily average kWh for analysis.\n\n`;
                    }
                    
                    successMessage += 
                        'What happens next:\n' +
                        '1. Our AI analyzes your utility bills and system specs\n' +
                        '2. You\'ll receive a detailed savings estimate within 24 hours\n' +
                        '3. We\'ll email instructions to connect your actual system\n' +
                        '4. Download the MicroVPP‚Ñ¢ app to view your results\n\n' +
                        'Check your email (' + payload.email + ') for your savings estimate!\n\n' +
                        '‚ö° Tesla Powerwall users: Support coming soon! We\'ll add you to our waitlist.';
                } else {
                    successMessage = 'üéâ Success! Your system is being connected to MicroGrid\'s VPP network!\n\n';
                    
                    if (totalFilesUploaded > 0 && hasMonthlyKwhData) {
                        successMessage += `We've received ${totalFilesUploaded} electricity bill file(s) and your monthly kWh usage data for additional analysis.\n\n`;
                    } else if (totalFilesUploaded > 0 && hasDailyAverageData) {
                        successMessage += `We've received ${totalFilesUploaded} electricity bill file(s) and your daily average kWh for additional analysis.\n\n`;
                    } else if (totalFilesUploaded > 0) {
                        successMessage += `We've received ${totalFilesUploaded} electricity bill file(s) for additional analysis.\n\n`;
                    } else if (hasMonthlyKwhData) {
                        successMessage += `We've received your monthly kWh usage data for additional analysis.\n\n`;
                    } else if (hasDailyAverageData) {
                        successMessage += `We've received your daily average kWh for additional analysis.\n\n`;
                    }
                    
                    successMessage += 
                        'What\'s next:\n' +
                        '1. We\'re verifying your connection (usually takes a few minutes)\n' +
                        '2. Download the MicroVPP‚Ñ¢ app from the App Store\n' +
                        '3. Sign in with your email: ' + payload.email + '\n' +
                        '4. Start monitoring your system and earning from VPP programs\n\n' +
                        'Check your email for confirmation and next steps!\n\n' +
                        '‚ö° Tesla Powerwall users: Support coming soon! We\'ll add you to our waitlist.';
                }

                // Show success message
                alert(successMessage);

                // Clear session storage
                sessionStorage.removeItem('registrationStep1');
                sessionStorage.removeItem('registrationStep2');
                sessionStorage.removeItem('registrationFiles');
                sessionStorage.removeItem('filesUploadedInStep1');
                sessionStorage.removeItem('usageChartUploadedInStep1');
                sessionStorage.removeItem('uploadedFileCount');

                // Redirect to home or app store
                window.location.href = 'index.html';

            } catch (error) {
                console.error('Registration error:', error);
                
                // Show error message
                alert(
                    '‚ùå Registration Error\n\n' +
                    'We encountered an issue while connecting your system:\n' +
                    error.message + '\n\n' +
                    'Please try again or contact support@microvpp.com for assistance.'
                );
            } finally {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.style.opacity = '1';
            }
        }

        // ============================================
        // ESTIMATION CACHING
        // ============================================
        // 
        // The quick estimation is cached based on a signature of:
        //   - Battery capacity
        //   - PV wattage
        //   - Monthly kWh data
        //   - Daily average kWh
        //   - Whether utility bills were uploaded
        //   - Whether usage chart was uploaded
        //   - Number of files uploaded
        //
        // Benefits:
        //   1. If user clicks cancel and then continue again, shows saved result instantly
        //   2. If user doesn't change any data and resubmits, no API call is made
        //   3. If user changes any input, cache is invalidated and new calculation occurs
        //
        // Cache is stored in sessionStorage and persists until:
        //   - User closes the tab/browser
        //   - User clears browser data
        //   - User changes any Step 1 input data
        // ============================================
        
        // Generate a signature/hash of the form data to detect changes
        function generateDataSignature(systemData, uploadedFilesInfo) {
            const dataString = JSON.stringify({
                batteryCapacity: systemData.batteryCapacity,
                pvWattage: systemData.pvWattage,
                monthlyKwh: systemData.monthlyKwh,
                dailyAverageKwh: systemData.dailyAverageKwh,
                hasUtilityBills: systemData.hasUtilityBills,
                hasUsageChart: systemData.hasUsageChart,
                filesCount: uploadedFilesInfo.total,
                filesUploaded: uploadedFilesInfo.uploaded
            });
            
            // Simple hash function (for production, consider using a proper hash library)
            let hash = 0;
            for (let i = 0; i < dataString.length; i++) {
                const char = dataString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }
        
        // Check if we have a cached estimation for the current data
        function getCachedEstimation(systemData, uploadedFilesInfo) {
            const currentSignature = generateDataSignature(systemData, uploadedFilesInfo);
            const cachedData = sessionStorage.getItem('quickEstimationCache');
            
            if (!cachedData) {
                return null;
            }
            
            try {
                const cache = JSON.parse(cachedData);
                if (cache.signature === currentSignature) {
                    console.log('Using cached estimation (data unchanged)');
                    return {
                        estimation: cache.estimation,
                        filesUploaded: cache.filesUploaded,
                        totalFiles: cache.totalFiles
                    };
                } else {
                    console.log('Data changed, cache invalidated');
                    return null;
                }
            } catch (error) {
                console.error('Error reading estimation cache:', error);
                return null;
            }
        }
        
        // Save estimation to cache
        function cacheEstimation(systemData, uploadedFilesInfo, estimation) {
            const signature = generateDataSignature(systemData, uploadedFilesInfo);
            const cache = {
                signature: signature,
                estimation: estimation,
                filesUploaded: uploadedFilesInfo.uploaded,
                totalFiles: uploadedFilesInfo.total,
                timestamp: new Date().toISOString()
            };
            
            sessionStorage.setItem('quickEstimationCache', JSON.stringify(cache));
            console.log('Estimation cached with signature:', signature);
        }
        
        // ============================================
        // QUICK ESTIMATION API (MOCK - TO BE REPLACED)
        // ============================================
        
        async function calculateQuickEstimation(systemData) {
            // TODO: Replace this mock function with actual backend REST API call
            // Expected endpoint: POST /api/calculate-quick-estimate
            
            // Simulate API delay (500ms - 1500ms)
            const delay = 500 + Math.random() * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            
            // Mock calculation based on system specs
            const batteryCapacity = parseFloat(systemData.batteryCapacity) || 10;
            const pvWattage = parseFloat(systemData.pvWattage) || 8;
            
            // Check if usage data was provided for confidence level
            const hasUsageData = systemData.hasUtilityBills || systemData.hasUsageChart || 
                                 (systemData.monthlyKwh && Object.keys(systemData.monthlyKwh).length > 0) ||
                                 (systemData.dailyAverageKwh && systemData.dailyAverageKwh.trim() !== '');
            
            // Simple mock formula: base on battery and solar capacity
            // Actual API will use sophisticated algorithms with usage data
            const baseEarnings = batteryCapacity * 50; // $50 per kWh of battery
            const solarBonus = pvWattage * 30; // $30 per kW of solar
            const randomVariation = (Math.random() * 0.3 - 0.15); // ¬±15% variation
            
            const estimatedYearlyEarnings = Math.round((baseEarnings + solarBonus) * (1 + randomVariation));
            const lowEstimate = Math.round(estimatedYearlyEarnings * 0.7);
            const highEstimate = Math.round(estimatedYearlyEarnings * 1.3);
            
            // Mock API response format
            return {
                success: true,
                estimation: {
                    yearly_low: lowEstimate,
                    yearly_high: highEstimate,
                    yearly_average: estimatedYearlyEarnings,
                    monthly_average: Math.round(estimatedYearlyEarnings / 12),
                    confidence_level: hasUsageData ? 'medium' : 'low',
                    message: 'Quick estimation calculated. More accurate estimates will be provided after detailed analysis.'
                }
            };
            
            // Uncomment below when actual API is ready:
            /*
            // NOTE: This function is called AFTER files are uploaded
            // The backend should use the uploaded files (utility bills, usage chart screenshot)
            // along with the system specs to calculate the estimation
            const response = await fetch(API_BASE_URL + '/api/calculate-quick-estimate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    battery_capacity_kwh: systemData.batteryCapacity,
                    pv_wattage_kw: systemData.pvWattage,
                    monthly_kwh: systemData.monthlyKwh,
                    daily_average_kwh: systemData.dailyAverageKwh,
                    has_utility_bills: systemData.hasUtilityBills,
                    has_usage_chart: systemData.hasUsageChart,
                    temp_user_id: systemData.tempUserId,
                    // Backend should fetch the uploaded files using temp_user_id
                    // Files are already uploaded to S3 at this point
                })
            });
            
            if (!response.ok) {
                throw new Error('Quick estimation API failed');
            }
            
            return await response.json();
            */
        }
        
        function showEstimationDialog(estimation, filesUploaded, totalFiles, isCached = false) {
            const yearlyRange = `$${estimation.yearly_low.toLocaleString()}‚Äì$${estimation.yearly_high.toLocaleString()}`;
            const monthlyAvg = `$${estimation.monthly_average.toLocaleString()}`;
            
            let confidenceText = '';
            if (estimation.confidence_level === 'medium') {
                confidenceText = 'This is a preliminary estimate based on your system specs and usage data.';
            } else {
                confidenceText = 'This is a preliminary estimate based on your system specs.';
            }
            
            let uploadStatus = '';
            if (totalFiles > 0) {
                if (filesUploaded === totalFiles) {
                    uploadStatus = `\nüìÅ All ${filesUploaded} file(s) uploaded successfully!\n`;
                } else if (filesUploaded > 0) {
                    uploadStatus = `\n‚ö†Ô∏è ${filesUploaded} of ${totalFiles} file(s) uploaded.\n`;
                } else {
                    uploadStatus = '\n‚ö†Ô∏è Files could not be uploaded.\n';
                }
            }
            
            const cacheNote = isCached ? '\n(Showing saved estimate - no changes detected)\n' : '';
            
            const message = 
                'üéâ Your Quick Earnings Estimate\n' +
                uploadStatus + cacheNote + '\n' +
                `üí∞ Estimated Annual Earnings: ${yearlyRange}/year\n` +
                `üìä Average Monthly: ${monthlyAvg}/month\n\n` +
                `${confidenceText}\n\n` +
                'We are running your simulation now (approximately 24 hours). Leave your email to receive the results.\n\n' +
                '‚ö° Tesla Powerwall users: Support coming soon! We\'ll add you to our waitlist.';
            
            return confirm(message);
        }
        
        // Helper function to calculate estimation and handle navigation after files uploaded
        async function calculateAndShowEstimation(systemData, submitBtn, filesUploaded, totalFiles) {
            try {
                const uploadedFilesInfo = {
                    uploaded: filesUploaded,
                    total: totalFiles
                };
                
                // Check if we have a cached estimation for this exact data
                const cachedResult = getCachedEstimation(systemData, uploadedFilesInfo);
                
                let estimation, resultFilesUploaded, resultTotalFiles;
                
                if (cachedResult) {
                    // Use cached estimation (no API call needed)
                    console.log('Using cached estimation result');
                    estimation = cachedResult.estimation;
                    resultFilesUploaded = cachedResult.filesUploaded;
                    resultTotalFiles = cachedResult.totalFiles;
                    
                    // Store estimation in session storage for later use
                    sessionStorage.setItem('quickEstimation', JSON.stringify(estimation));
                } else {
                    // Calculate new estimation
                    submitBtn.textContent = 'Calculating your estimate...';
                    
                    console.log('Calculating quick estimation after file upload...');
                    const estimationResult = await calculateQuickEstimation(systemData);
                    
                    if (!estimationResult.success) {
                        console.warn('Quick estimation failed, asking user to continue anyway');
                        if (confirm('Unable to calculate estimate, but your data has been saved. Continue to Step 2?')) {
                            window.location.href = 'diy-registration-step2.html';
                        } else {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Calculate Quick Estimate & Continue';
                        }
                        return;
                    }
                    
                    console.log('Quick estimation calculated:', estimationResult.estimation);
                    estimation = estimationResult.estimation;
                    resultFilesUploaded = filesUploaded;
                    resultTotalFiles = totalFiles;
                    
                    // Cache the estimation result
                    cacheEstimation(systemData, uploadedFilesInfo, estimation);
                    
                    // Store estimation in session storage for later use
                    sessionStorage.setItem('quickEstimation', JSON.stringify(estimation));
                }
                
                // Show estimation dialog with upload status
                const userWantsToContinue = showEstimationDialog(
                    estimation, 
                    resultFilesUploaded, 
                    resultTotalFiles,
                    cachedResult !== null  // indicate if this is cached data
                );
                
                if (userWantsToContinue) {
                    // User confirmed, proceed to step 2
                    window.location.href = 'diy-registration-step2.html';
                } else {
                    // User cancelled, restore button
                    // Estimation is cached, so clicking again will show same result
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Calculate Quick Estimate & Continue';
                }
                
            } catch (error) {
                console.error('Error calculating quick estimation:', error);
                // Ask user if they want to continue despite estimation error
                if (confirm('Unable to calculate quick estimate at this time, but your data has been saved. Continue to Step 2?')) {
                    window.location.href = 'diy-registration-step2.html';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Calculate Quick Estimate & Continue';
                }
            }
        }

        // Form submit handler
        document.getElementById('diyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const batteryCapacity = formData.get('batteryCapacity');
            const pvWattage = formData.get('pvWattage');
            
            // Custom validation - battery and solar specs are required
            let errors = [];
            
            if (!batteryCapacity || parseFloat(batteryCapacity) <= 0) {
                errors.push('- Battery capacity is required and must be greater than 0');
                document.getElementById('batteryCapacity').style.borderColor = '#ef4444';
            } else {
                document.getElementById('batteryCapacity').style.borderColor = '#e5e7eb';
            }
            
            if (!pvWattage || parseFloat(pvWattage) <= 0) {
                errors.push('- Solar panel capacity is required and must be greater than 0');
                document.getElementById('pvWattage').style.borderColor = '#ef4444';
            } else {
                document.getElementById('pvWattage').style.borderColor = '#e5e7eb';
            }
            
            // Check usage data - at least one of three options is required
            // Collect monthly kWh data first to check if any was provided
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const monthlyKwhData = {};
            let hasMonthlyData = false;
            for (const monthName of monthNames) {
                const monthValue = formData.get(`month${monthName}`);
                if (monthValue && monthValue.trim() !== '') {
                    monthlyKwhData[`month${monthName}`] = monthValue;
                    hasMonthlyData = true;
                }
            }
            
            // Check daily average
            const dailyAverageKwh = formData.get('dailyAverageKwh');
            const hasDailyAverage = dailyAverageKwh && dailyAverageKwh.trim() !== '';
            
            // Check if utility bills were uploaded (either in this session or previously)
            const hasUtilityBills = uploadedFiles.length > 0 || sessionStorage.getItem('filesUploadedInStep1') === 'true';
            
            // Check if usage chart screenshot was uploaded (either in this session or previously)
            const hasUsageChart = usageChartFile !== null || sessionStorage.getItem('usageChartUploadedInStep1') === 'true';
            
            // Validate that at least one usage data option is provided
            if (!hasUtilityBills && !hasMonthlyData && !hasDailyAverage && !hasUsageChart) {
                errors.push('- Usage data is required');
            }
            
            // Show validation errors
            if (errors.length > 0) {
                let errorMessage = '‚ö†Ô∏è Missing Required Information:\n\n' + errors.join('\n');
                
                // Add helpful hint if usage data is missing
                if (!hasUtilityBills && !hasMonthlyData && !hasDailyAverage && !hasUsageChart) {
                    errorMessage += '\n\nüí° You must provide at least ONE of the following:\n';
                    errorMessage += '   ‚Ä¢ Upload utility bills (PDF or images)\n';
                    errorMessage += '   ‚Ä¢ Upload a screenshot of your usage chart\n';
                    errorMessage += '   ‚Ä¢ Enter monthly kWh usage for at least one month\n';
                    errorMessage += '   ‚Ä¢ Enter your daily average kWh usage\n';
                    errorMessage += '\nScroll down to the "Usage Data" section to provide this information.';
                    
                    // Scroll to the usage data section
                    setTimeout(() => {
                        const usageSection = document.querySelector('.tab-content');
                        if (usageSection) {
                            usageSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 500);
                } else {
                    errorMessage += '\n\nPlease provide the required information to continue.';
                }
                
                alert(errorMessage);
                return;
            }
            
            // Generate or retrieve temporary UUID for this session
            let tempUserId = sessionStorage.getItem('tempUserId');
            if (!tempUserId) {
                tempUserId = generateUUID();
                sessionStorage.setItem('tempUserId', tempUserId);
                console.log('Generated temporary user ID:', tempUserId);
            }
            
            // Prepare system data
            const step1SystemData = {
                batteryCapacity: formData.get('batteryCapacity'),
                pvWattage: formData.get('pvWattage'),
                monthlyKwh: monthlyKwhData,
                dailyAverageKwh: formData.get('dailyAverageKwh'),
                hasUtilityBills: hasUtilityBills,
                hasUsageChart: hasUsageChart,
                tempUserId: tempUserId
            };
            
            // Save step 1 data
            console.log('Saving step 1 data');
            sessionStorage.setItem('registrationStep1', JSON.stringify(step1SystemData));
            
            // Prepare for upload and estimation
            const submitBtn = document.getElementById('submitBtn');
            const originalButtonText = submitBtn.textContent;
            submitBtn.disabled = true;
            
            // Separate utility bills from usage chart screenshot
            const utilityBills = [...uploadedFiles];
            const screenshots = usageChartFile ? [usageChartFile] : [];
            
            // Check if files were already uploaded in a previous session
            const filesAlreadyUploaded = sessionStorage.getItem('filesUploadedInStep1') === 'true';
            
            const hasFilesToUpload = (utilityBills.length > 0 || screenshots.length > 0) && !filesAlreadyUploaded;
            
            if (hasFilesToUpload) {
                submitBtn.textContent = 'Uploading files...';
                submitBtn.disabled = true;
                
                let totalFilesUploaded = 0;
                let uploadErrors = [];
                
                try {
                    // Upload utility bills as ZIP if multiple, otherwise as single file
                    if (utilityBills.length > 0) {
                        console.log(`Uploading ${utilityBills.length} utility bill(s)...`);
                        
                        const onProgress = (batchIndex, totalBatches, filesUploaded, totalFiles) => {
                            const percent = Math.round((filesUploaded / (utilityBills.length + screenshots.length)) * 100);
                            submitBtn.textContent = `Uploading files (${percent}%)...`;
                        };
                        
                        const billUploadResult = await uploadUtilityBills(tempUserId, utilityBills, onProgress);
                        
                        if (billUploadResult.success) {
                            totalFilesUploaded += billUploadResult.uploadedFiles.length;
                            console.log(`Successfully uploaded ${billUploadResult.uploadedFiles.length} utility bill(s)`);
                        } else {
                            uploadErrors.push(...billUploadResult.errors);
                            console.warn('Some utility bills failed to upload:', billUploadResult.errors);
                        }
                    }
                    
                    // Upload screenshots individually (not zipped)
                    if (screenshots.length > 0) {
                        console.log(`Uploading ${screenshots.length} screenshot(s) individually...`);
                        
                        let screenshotsUploaded = 0;
                        for (let i = 0; i < screenshots.length; i++) {
                            const screenshot = screenshots[i];
                            const percent = Math.round(((totalFilesUploaded + i) / (utilityBills.length + screenshots.length)) * 100);
                            submitBtn.textContent = `Uploading screenshot (${percent}%)...`;
                            
                            try {
                                // Get pre-signed URL for screenshot
                                const presignedResponse = await getPresignedUrls(tempUserId, [screenshot]);
                                
                                if (presignedResponse.presigned_urls && presignedResponse.presigned_urls.length > 0) {
                                    await uploadFileToS3(screenshot, presignedResponse.presigned_urls[0], 1, 1);
                                    totalFilesUploaded++;
                                    screenshotsUploaded++;
                                    console.log(`Successfully uploaded screenshot: ${screenshot.name}`);
                                } else {
                                    uploadErrors.push(`Screenshot upload failed: no pre-signed URL`);
                                }
                            } catch (error) {
                                uploadErrors.push(`Screenshot ${screenshot.name}: ${error.message}`);
                                console.error('Screenshot upload error:', error);
                            }
                        }
                        
                        // Mark usage chart screenshots as uploaded
                        if (screenshotsUploaded > 0) {
                            sessionStorage.setItem('usageChartUploadedInStep1', 'true');
                        }
                    }
                    
                    // Mark files as uploaded
                    if (totalFilesUploaded > 0) {
                        sessionStorage.setItem('filesUploadedInStep1', 'true');
                        sessionStorage.setItem('uploadedFileCount', totalFilesUploaded.toString());
                        console.log(`Total files uploaded: ${totalFilesUploaded}/${utilityBills.length + screenshots.length}`);
                    }
                    
                    // Handle results
                    const totalFiles = utilityBills.length + screenshots.length;
                    
                    // Calculate estimation after files are uploaded
                    await calculateAndShowEstimation(step1SystemData, submitBtn, totalFilesUploaded, totalFiles);
                    
                } catch (error) {
                    console.error('Error uploading files:', error);
                    if (confirm('Error uploading files. Continue without files?')) {
                        // Calculate estimation even if files failed
                        await calculateAndShowEstimation(step1SystemData, submitBtn, 0, 0);
                    } else {
                        submitBtn.textContent = originalButtonText;
                        submitBtn.disabled = false;
                    }
                }
            } else {
                // No files to upload, calculate estimation immediately
                await calculateAndShowEstimation(step1SystemData, submitBtn, 0, 0);
            }
        });

        // Check for invitation code before downloading app
        function checkInvitationCode(event) {
            event.preventDefault();
            
            const hasInvitationCode = confirm(
                'üéüÔ∏è Invitation Code Required\n\n' +
                'Our app is currently in invitation-only beta mode.\n\n' +
                'Do you have an invitation code?'
            );
            
            if (hasInvitationCode) {
                // User has invitation code - open App Store
                window.open('https://apps.apple.com/us/app/dgrid/id6747276150', '_blank');
            } else {
                // User doesn't have invitation code - show message
                alert(
                    'üí° Complete Your Free Analysis!\n\n' +
                    'You\'re already on the right page! Complete this system analysis and we\'ll send you an invitation code if you qualify for our beta test.\n\n' +
                    'Benefits:\n' +
                    '‚úì Personalized savings estimate\n' +
                    '‚úì See your earning potential\n' +
                    '‚úì Beta invitation code (if you qualify)\n' +
                    '‚úì Priority access when we launch\n\n' +
                    'Scroll down to complete the form - takes just 2-3 minutes!'
                );
            }
            
            // Track the interaction
            if (typeof gtag !== 'undefined') {
                gtag('event', 'app_download_check', {
                    event_category: 'engagement',
                    event_label: hasInvitationCode ? 'has_code' : 'needs_code',
                    page: 'step1'
                });
            }
        }
    </script>
</body>
</html>

